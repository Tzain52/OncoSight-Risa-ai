
> onco@0.1.0 lint
> eslint --format=json

[{"filePath":"/Users/a38371/Desktop/onco/eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/actions/analyze-patient.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'electrolytes' is assigned a value but never used.","line":116,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":116,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\";\n\nimport { gemini } from \"@/lib/gemini\";\nimport type { Patient } from \"@/types/patient\";\nimport type { MasterAIResponse } from \"@/types/patient-insights\";\n\nconst MODEL_NAME = \"gemini-2.5-flash\";\n\nconst SYSTEM_PROMPT = [\n  \"You are an expert Medical Oncologist and Senior Clinical Data Analyst.\",\n  \"\",\n  \"Objective:\",\n  \"Analyze the provided raw patient record (flattened JSON object from a CSV row) and generate a structured Clinical Intelligence Object in strict JSON format for the OncoSight dashboard.\",\n  \"\",\n  \"Input Data:\",\n  \"- Scalar fields such as Age, Primary diagnosis, etc.\",\n  \"- Stringified JSON arrays for longitudinal data (e.g., Treatment_Timeline_JSON, Biomarker_Trend_JSON).\",\n  \"- Free-text summaries (e.g., Overall disease course summary).\",\n  \"\",\n  \"Output Requirement:\",\n  \"Return ONE valid JSON object matching the following TypeScript interface exactly. No markdown or extra text.\",\n  JSON.stringify({\n    sidebar: {\n      dynamic_insights: [\n        {\n          label: \"string\",\n          value: \"string\",\n          priority: \"'High' | 'Medium'\",\n        },\n      ],\n      safety_flags: {\n        renal: {\n          status: \"'Safe' | 'Caution' | 'Danger'\",\n          details: \"string\",\n        },\n        liver: {\n          status: \"'Safe' | 'Caution' | 'Danger'\",\n          details: \"string\",\n        },\n        hematology: {\n          status: \"'Safe' | 'Caution' | 'Danger'\",\n          details: \"string\",\n        },\n      },\n    },\n    charts: {\n      tumor_size: {\n        should_render: \"boolean\",\n        reason: \"string\",\n      },\n      biomarkers: {\n        should_render: \"boolean\",\n        selected_marker: \"string\",\n        reason: \"string\",\n      },\n    },\n    tabs: {\n      diagnosis: {\n        mutation_highlight: \"string\",\n        summary: \"string\",\n      },\n      investigation: {\n        trend_analysis: \"string\",\n      },\n      treatment: {\n        current_strategy: \"string\",\n      },\n    },\n    stage_summary: \"string\",\n  }),\n  \"\",\n  \"Sidebar guidance:\",\n  \"- Story: Extract 3-5 most critical features. Max 10 words per value, telegraphic style (no full sentences).\",\n  '- Example bad: \"The patient has a confirmed KRAS mutation which is driving the disease.\"',\n  '- Example good: \"Driver: KRAS G12C (Actionable)\".',\n  \"- Safety flags: Detail strings must be <=5 words (e.g., 'Cr 1.5 (Stable)', 'AST/ALT elevated (Gr1)'). Reference real labs/flags.\",\n  \"\",\n  \"Logic notes:\",\n  \"- For tumor_size charts: render only if Tumor_Size_Trend_JSON has >=2 numeric points.\",\n  \"- For biomarkers: same rule, ensure numeric values; pick the most relevant marker name.\",\n  \"- Safety flags must reference the appropriate lab/flag fields from the input.\",\n  \"- Stage summary must be ≤5 words, focus on stage evolution (e.g., 'Stage IV stable', 'Progression to Stage IV').\",\n  \"- Keep language clinical, concise, and JSON-valid.\",\n  \"\",\n  \"Pathology evolution analysis (populate investigations.pathology_comparison_text + pathology_deltas):\",\n  \"- Input dataset: patient.pathology_details_json, ordered chronologically.\",\n  \"- Scenario A (>=2 reports): Compare latest vs immediately previous report. Write a 2-3 sentence professional summary focusing on histology shifts, biomarker flips, and new sites. Emit up to 4 delta objects capturing markers that changed. Trends must be one of 'worsening', 'improving', 'stable', 'new'.\",\n  \"- Scenario B (exactly 1 report): Summarize current findings in 1-2 sentences. Return an empty array for pathology_deltas.\",\n  \"- Scenario C (no reports): Set both pathology_comparison_text and pathology_deltas to null.\",\n  \"- Each delta object must include { marker, old_value, new_value, trend }. Use string values (or null when missing) and keep terminology clinically precise.\",\n  \"\",\n  \"Laboratory & metabolic intelligence (populate investigations.labs_summary in ≤3 sentences):\",\n  \"- Inputs: CBC values, CMP values, Electrolytes, Renal/Liver dysfunction flags, CEA, CA19-9, Biomarker_Trend_JSON, abnormal lab flags, longitudinal lab trends.\",\n  \"- Always prioritize safety: mention renal dysfunction (flag Yes or Creatinine >1.5) and liver dysfunction (flag Yes). Call out implications (e.g., contrast caution, hepatotoxicity monitoring).\",\n  \"- Assess cytopenias: WBC <2.0 or ANC <1.0 (neutropenia), Hb <10 (anemia), Platelets <75 (thrombocytopenia). Include grade/severity plus clinical action.\",\n  \"- Evaluate tumor marker trajectory: if CEA/CA19-9 or Biomarker_Trend_JSON increases >20% between last two readings, signal possible progression; if decreasing >20%, denote response; else state stability.\",\n  \"- Tone clinical, professional, max 3 sentences summarizing abnormalities, implications, and trend.\",\n].join(\"\\n\");\n\nconst extractNumber = (source?: string | null, patterns: RegExp[] = []) => {\n  if (!source) return null;\n  const normalized = source.replace(/,/g, \" \");\n  for (const pattern of patterns) {\n    const match = normalized.match(pattern);\n    if (match) {\n      const value = Number.parseFloat(match[1]);\n      if (Number.isFinite(value)) return value;\n    }\n  }\n  return null;\n};\n\nconst buildLabsSummary = (patient: Patient): string => {\n  const cbc = patient.cbcValues;\n  const cmp = patient.cmpValues;\n  const electrolytes = patient.electrolytes;\n\n  const creatinine = extractNumber(cmp, [/Cr(?:eat(?:inine)?)?\\s*(\\d+\\.?\\d*)/i, /Creatinine[:=]?\\s*(\\d+\\.?\\d*)/i]);\n  const wbc = extractNumber(cbc, [/WBC[:\\s]+(\\d+\\.?\\d*)/i]);\n  const anc = extractNumber(cbc, [/ANC[:\\s]+(\\d+\\.?\\d*)/i, /Absolute\\s+Neutrophil(?:\\s+Count)?[:\\s]+(\\d+\\.?\\d*)/i]);\n  const hb = extractNumber(cbc, [/(?:Hb|Hgb)[:\\s]+(\\d+\\.?\\d*)/i]);\n  const platelets = extractNumber(cbc, [/(?:Platelets?|Plt)[:\\s]+(\\d+\\.?\\d*)/i]);\n\n  const renalFlag = patient.renalDysfunctionFlag ?? null;\n  const liverFlag = patient.liverDysfunctionFlag ?? null;\n\n  const statements: string[] = [];\n\n  if (renalFlag || (creatinine !== null && creatinine > 1.5)) {\n    statements.push(\"Renal reserve compromised; use contrast and nephrotoxic agents cautiously.\");\n  } else {\n    statements.push(\"Renal parameters remain acceptable for planned therapy.\");\n  }\n\n  if (liverFlag) {\n    statements.push(\"Hepatic dysfunction present—monitor metabolism-dependent drugs closely.\");\n  }\n\n  const hemeIssues: string[] = [];\n  if ((wbc !== null && wbc < 2) || (anc !== null && anc < 1)) {\n    hemeIssues.push(\"Neutropenia elevates infectious risk\");\n  }\n  if (hb !== null && hb < 10) {\n    hemeIssues.push(`Anemia noted (Hb ${hb.toFixed(1)})`);\n  }\n  if (platelets !== null && platelets < 75) {\n    hemeIssues.push(\"Thrombocytopenia may predispose to bleeding\");\n  }\n  if (hemeIssues.length) {\n    statements.push(`${hemeIssues.join(\"; \")}.`);\n  } else {\n    statements.push(\"Hematologic indices are within acceptable limits.\");\n  }\n\n  const trendMessage = (() => {\n    const trendSeries = patient.biomarkerTrend ?? [];\n    const latest = trendSeries.at(-1);\n    const prev = trendSeries.length >= 2 ? trendSeries.at(-2) : undefined;\n\n    const parseMarkerValue = (target: string): number | null => {\n      const direct =\n        target === \"CEA\"\n          ? extractNumber(patient.cea, [/(\\d+\\.?\\d*)/])\n          : extractNumber(patient.ca199, [/(\\d+\\.?\\d*)/]);\n      if (direct !== null) return direct;\n      const filtered = trendSeries.filter(\n        (point) => point.markerName?.toLowerCase() === target.toLowerCase() && typeof point.value === \"number\",\n      );\n      if (filtered.length >= 2) {\n        return (filtered.at(-1)?.value as number) ?? null;\n      }\n      return null;\n    };\n\n    if (latest && prev && typeof latest.value === \"number\" && typeof prev.value === \"number\") {\n      const delta = latest.value - prev.value;\n      const percent = prev.value !== 0 ? delta / prev.value : 0;\n      if (percent > 0.2) return \"Recently rising biomarkers suggest potential disease activity.\";\n      if (percent < -0.2) return \"Down-trending biomarkers align with treatment response.\";\n    }\n\n    const ceaValue = parseMarkerValue(\"CEA\");\n    const caValue = parseMarkerValue(\"CA19-9\");\n    if (ceaValue !== null || caValue !== null) {\n      return \"Tumor markers are stable without decisive directional shifts.\";\n    }\n\n    return \"Tumor markers unavailable for trajectory assessment.\";\n  })();\n\n  statements.push(trendMessage);\n\n  return statements.filter(Boolean).slice(0, 3).join(\" \");\n};\n\nconst buildFallbackInsights = (patient: Patient): MasterAIResponse => {\n  const tumorTrend = patient.tumorSizeTrend ?? [];\n  const biomarkerTrend = patient.biomarkerTrend ?? [];\n  const hasTumorTrend = tumorTrend.filter((point) => typeof point.sumOfDiametersMm === \"number\").length >= 2;\n  const hasBiomarkerTrend = biomarkerTrend.filter((point) => typeof point.value === \"number\").length >= 2;\n  const driver =\n    patient.actionableMutationSummary ||\n    patient.egfrMutation ||\n    patient.alkRearrangement ||\n    patient.ros1Rearrangement ||\n    patient.krasMutation ||\n    patient.brafMutation ||\n    \"No actionable mutation noted\";\n  const stageSummary = patient.currentTnmStage\n    ? `${patient.currentTnmStage} status`\n    : patient.initialTnmStage\n      ? `${patient.initialTnmStage} status`\n      : \"Stage pending\";\n  const renalStatus = patient.renalDysfunctionFlag ? \"Caution\" : \"Safe\";\n  const liverStatus = patient.liverDysfunctionFlag ? \"Caution\" : \"Safe\";\n  const hemeStatus =\n    /low|anemia|thrombocytopenia|leukopenia/i.test(patient.cbcValues ?? \"\") || /flag/i.test(patient.abnormalLabFlags ?? \"\")\n      ? \"Caution\"\n      : \"Safe\";\n  const labsSummary = buildLabsSummary(patient);\n\n  return {\n    sidebar: {\n      dynamic_insights: [\n        {\n          label: patient.primaryDiagnosis || \"Primary diagnosis pending\",\n          value: driver,\n          priority: \"High\",\n        },\n        {\n          label: \"Therapy status\",\n          value: patient.currentLineOfTherapy || patient.treatmentPlanSummary || \"No active plan logged\",\n          priority: \"Medium\",\n        },\n        {\n          label: \"Metastatic status\",\n          value: patient.metastaticStatus || patient.recurrenceStatus || \"Not documented\",\n          priority: \"Medium\",\n        },\n      ],\n      safety_flags: {\n        renal: {\n          status: renalStatus,\n          details: patient.cmpValues ? patient.cmpValues.slice(0, 40) : \"Creatinine trend unavailable\",\n        },\n        liver: {\n          status: liverStatus,\n          details: patient.cmpValues ? patient.cmpValues.slice(0, 40) : \"LFTs unavailable\",\n        },\n        hematology: {\n          status: hemeStatus === \"Safe\" ? \"Safe\" : \"Caution\",\n          details: patient.cbcValues ? patient.cbcValues.slice(0, 40) : \"CBC data unavailable\",\n        },\n      },\n    },\n    charts: {\n      tumor_size: {\n        should_render: hasTumorTrend,\n        reason: hasTumorTrend ? \">=2 tumor measurements\" : \"Need at least 2 tumor measurements\",\n      },\n      biomarkers: {\n        should_render: hasBiomarkerTrend,\n        selected_marker: biomarkerTrend[0]?.markerName || \"Biomarker\",\n        reason: hasBiomarkerTrend ? \">=2 biomarker datapoints\" : \"Need at least 2 biomarker datapoints\",\n      },\n    },\n    tabs: {\n      diagnosis: {\n        mutation_highlight: driver,\n        summary: patient.overallDiseaseCourseSummary || patient.histopathologicFeatures || \"Disease summary unavailable.\",\n      },\n      investigation: {\n        trend_analysis:\n          patient.radiologyTrend || patient.radiologyImpressionKeywords || \"No structured radiology trend available.\",\n      },\n      treatment: {\n        current_strategy: patient.treatmentPlanSummary || patient.currentLineOfTherapy || \"Plan not documented.\",\n      },\n    },\n    stage_summary: stageSummary,\n    investigations: {\n      pathology_summary: patient.pathologyDiagnosisText || patient.histopathologicFeatures || null,\n      pathology_comparison_text: null,\n      pathology_deltas: null,\n      labs_summary: labsSummary,\n    },\n  };\n};\n\nexport async function generatePatientInsights(patient: Patient): Promise<MasterAIResponse> {\n  const model = gemini.getGenerativeModel({\n    model: MODEL_NAME,\n    generationConfig: {\n      responseMimeType: \"application/json\",\n    },\n    systemInstruction: SYSTEM_PROMPT,\n  });\n\n  const prompt = [\n    \"Analyze this patient JSON and respond with only valid JSON.\",\n    \"\",\n    \"Patient JSON:\",\n    JSON.stringify(patient, null, 2),\n  ].join(\"\\n\");\n\n  let text: string | null = null;\n  try {\n    const result = await model.generateContent(prompt);\n    text = result.response.text();\n    const parsed = JSON.parse(text) as MasterAIResponse;\n    if (!parsed.investigations) {\n      parsed.investigations = {\n        pathology_summary: null,\n        pathology_comparison_text: null,\n        pathology_deltas: null,\n        labs_summary: null,\n      };\n    }\n    if (!parsed.investigations.labs_summary) {\n      parsed.investigations.labs_summary = buildLabsSummary(patient);\n    }\n    return parsed;\n  } catch (error) {\n    console.error(\"Gemini fetch or parse failed. Falling back to deterministic insights.\", {\n      error,\n      rawResponse: text,\n    });\n    return buildFallbackInsights(patient);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/api/clinical-summary/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/dashboard/[id]/layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/dashboard/[id]/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/debug/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/list/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/app/patient/[id]/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/dashboard-tabs-client.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/a38371/Desktop/onco/src/components/dashboard-tabs-client.tsx:64:5\n  62 |\n  63 |   useEffect(() => {\n> 64 |     setMainTab(\"patient\");\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  65 |     setInvestigationsPanel(\"pathology\");\n  66 |   }, [patient.patientId]);\n  67 |","line":64,"column":5,"nodeType":null,"endLine":64,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as Tabs from \"@radix-ui/react-tabs\";\nimport { useEffect, useMemo, useState } from \"react\";\n\nimport { DiagnosisTab } from \"@/components/tabs/diagnosis-tab\";\nimport { InvestigationsTab } from \"@/components/tabs/investigations-tab\";\nimport { PatientTab } from \"@/components/tabs/patient-tab\";\nimport { ReferencesTab } from \"@/components/tabs/references-tab\";\nimport type { MasterAIResponse } from \"@/types/patient-insights\";\nimport type { Patient } from \"@/types/patient\";\n\ntype MainTab = \"patient\" | \"diagnosis\" | \"investigations\" | \"references\";\ntype InvestigationsPanel = \"pathology\" | \"radiology\" | \"laboratory\";\n\ninterface DashboardTabsClientProps {\n  patient: Patient;\n  aiInsights: MasterAIResponse | null;\n}\n\nconst SHORTCUTS = [\n  {\n    keys: [\"o\", \"p\"],\n    handler: (setMain: (tab: MainTab) => void) => setMain(\"patient\"),\n  },\n  {\n    keys: [\"o\", \"d\"],\n    handler: (setMain: (tab: MainTab) => void) => setMain(\"diagnosis\"),\n  },\n  {\n    keys: [\"o\", \"i\"],\n    handler: (setMain: (tab: MainTab) => void, setPanel: (panel: InvestigationsPanel) => void) => {\n      setMain(\"investigations\");\n      setPanel(\"pathology\");\n    },\n  },\n  {\n    keys: [\"o\", \"i\", \"r\"],\n    handler: (setMain: (tab: MainTab) => void, setPanel: (panel: InvestigationsPanel) => void) => {\n      setMain(\"investigations\");\n      setPanel(\"radiology\");\n    },\n  },\n  {\n    keys: [\"o\", \"i\", \"l\"],\n    handler: (setMain: (tab: MainTab) => void, setPanel: (panel: InvestigationsPanel) => void) => {\n      setMain(\"investigations\");\n      setPanel(\"laboratory\");\n    },\n  },\n];\n\nconst hasPrefix = (sequence: string[]) =>\n  SHORTCUTS.some((shortcut) => shortcut.keys.slice(0, sequence.length).every((key, index) => key === sequence[index]));\n\nconst resolveShortcut = (sequence: string[]) =>\n  SHORTCUTS.find((shortcut) => shortcut.keys.length === sequence.length && shortcut.keys.every((key, idx) => key === sequence[idx]));\n\nexport function DashboardTabsClient({ patient, aiInsights }: DashboardTabsClientProps) {\n  const [mainTab, setMainTab] = useState<MainTab>(\"patient\");\n  const [investigationsPanel, setInvestigationsPanel] = useState<InvestigationsPanel>(\"pathology\");\n\n  useEffect(() => {\n    setMainTab(\"patient\");\n    setInvestigationsPanel(\"pathology\");\n  }, [patient.patientId]);\n\n  useEffect(() => {\n    let sequence: string[] = [];\n    let timeout: ReturnType<typeof setTimeout> | null = null;\n\n    const resetSequence = () => {\n      sequence = [];\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = null;\n      }\n    };\n\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (event.isComposing || event.repeat) return;\n      const key = event.key.toLowerCase();\n      if (!key) return;\n\n      if (sequence.length === 0 && key !== \"o\") {\n        return;\n      }\n\n      sequence.push(key);\n\n      if (!hasPrefix(sequence)) {\n        resetSequence();\n        return;\n      }\n\n      const match = resolveShortcut(sequence);\n      if (match) {\n        event.preventDefault();\n        match.handler(setMainTab, setInvestigationsPanel);\n        resetSequence();\n        return;\n      }\n\n      if (timeout) clearTimeout(timeout);\n      timeout = setTimeout(resetSequence, 750);\n    };\n\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => {\n      window.removeEventListener(\"keydown\", handleKeyDown);\n      resetSequence();\n    };\n  }, []);\n\n  const tabs = useMemo(\n    () => [\n      { value: \"patient\" as const, label: \"Patient\" },\n      { value: \"diagnosis\" as const, label: \"Diagnosis\" },\n      { value: \"investigations\" as const, label: \"Investigations\" },\n      { value: \"references\" as const, label: \"References\" },\n    ],\n    [],\n  );\n\n  return (\n    <section className=\"flex h-full flex-col\">\n      <Tabs.Root value={mainTab} onValueChange={(value) => setMainTab(value as MainTab)} className=\"flex h-full flex-col\">\n        <Tabs.List className=\"sticky top-0 z-10 flex w-full items-center gap-3 border-b border-slate-100 bg-white/95 px-4 py-4 text-sm font-semibold text-slate-500 shadow-[0_2px_12px_rgba(15,23,42,0.05)] backdrop-blur\">\n          {tabs.map((tab) => (\n            <Tabs.Trigger\n              key={tab.value}\n              value={tab.value}\n              className=\"rounded-full px-5 py-2 transition focus-visible:outline-none data-[state=active]:bg-slate-900 data-[state=active]:text-white data-[state=active]:shadow-[0_8px_20px_rgba(15,23,42,0.18)] data-[state=inactive]:bg-slate-100/60 data-[state=inactive]:text-slate-500\"\n            >\n              {tab.label}\n            </Tabs.Trigger>\n          ))}\n        </Tabs.List>\n\n        <div className=\"flex-1 overflow-y-auto py-6\">\n          <Tabs.Content value=\"patient\" className=\"focus:outline-none\">\n            <PatientTab patient={patient} />\n          </Tabs.Content>\n          <Tabs.Content value=\"diagnosis\" className=\"focus:outline-none\">\n            <DiagnosisTab patient={patient} />\n          </Tabs.Content>\n          <Tabs.Content value=\"investigations\" className=\"focus:outline-none\">\n            <InvestigationsTab\n              patient={patient}\n              aiInsights={aiInsights ?? null}\n              activePanel={investigationsPanel}\n              onPanelChange={setInvestigationsPanel}\n            />\n          </Tabs.Content>\n          <Tabs.Content value=\"references\" className=\"focus:outline-none\">\n            <ReferencesTab patient={patient} />\n          </Tabs.Content>\n        </div>\n      </Tabs.Root>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/patient-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/patient-inspector.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/a38371/Desktop/onco/src/components/patient-inspector.tsx:155:5\n  153 |   useEffect(() => {\n  154 |     if (!patient) return;\n> 155 |     setInsights(null);\n      |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  156 |     setError(null);\n  157 |     startTransition(() => {\n  158 |       void fetchInsights(patient);","line":155,"column":5,"nodeType":null,"endLine":155,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useCallback, useEffect, useMemo, useState, useTransition } from \"react\";\n\nimport type { Patient } from \"@/types/patient\";\nimport type { MasterAIResponse } from \"@/types/dashboard\";\n\ninterface PatientInspectorProps {\n  patients: Patient[];\n  analyzePatient: (patient: Patient) => Promise<MasterAIResponse>;\n}\n\nconst COMPLEX_FIELDS: (keyof Patient)[] = [\n  \"treatmentTimeline\",\n  \"tumorSizeTrend\",\n  \"biomarkerTrend\",\n  \"pathologyDetails\",\n  \"pathologyReports\",\n  \"genomicReports\",\n  \"radiologyReports\",\n  \"providerNotes\",\n];\n\nconst FIELD_LABELS: Record<keyof Patient, string> = {\n  patientId: \"Patient ID\",\n  name: \"Name\",\n  bmi: \"BMI\",\n  bsa: \"BSA\",\n  age: \"Age\",\n  sex: \"Sex\",\n  smokingStatus: \"Smoking Status\",\n  performanceStatus: \"Performance Status\",\n  diabetes: \"Diabetes\",\n  hypertension: \"Hypertension\",\n  heartDisease: \"Heart Disease\",\n  copdAsthma: \"COPD / Asthma\",\n  otherRelevantComorbidities: \"Other Relevant Comorbidities\",\n  primaryDiagnosis: \"Primary Diagnosis\",\n  histologicType: \"Histologic Type\",\n  tumorGrade: \"Tumor Grade\",\n  diagnosisDate: \"Diagnosis Date\",\n  initialTnmStage: \"Initial TNM Stage\",\n  currentTnmStage: \"Current TNM Stage\",\n  metastaticStatus: \"Metastatic Status\",\n  metastaticSites: \"Metastatic Sites\",\n  recurrenceStatus: \"Recurrence Status\",\n  pathologyDiagnosisText: \"Pathology Diagnosis Text\",\n  histopathologicFeatures: \"Histopathologic Features\",\n  marginStatus: \"Margin Status\",\n  ihcMarkers: \"IHC Markers\",\n  ambiguousDiagnosisFlag: \"Ambiguous Diagnosis Flag\",\n  egfrMutation: \"EGFR Mutation\",\n  alkRearrangement: \"ALK Rearrangement\",\n  ros1Rearrangement: \"ROS1 Rearrangement\",\n  krasMutation: \"KRAS Mutation\",\n  brafMutation: \"BRAF Mutation\",\n  metExon14Skipping: \"MET Exon 14 Skipping\",\n  retRearrangement: \"RET Rearrangement\",\n  her2Mutation: \"HER2 Mutation\",\n  ntrkFusion: \"NTRK Fusion\",\n  pdL1Expression: \"PD-L1 Expression (%)\",\n  tumorMutationalBurden: \"Tumor Mutational Burden (TMB)\",\n  microsatelliteInstability: \"Microsatellite Instability (MSI)\",\n  ctdnaFindings: \"ctDNA Findings\",\n  actionableMutationSummary: \"Actionable Mutation Summary\",\n  newMutationsOverTime: \"New Mutations Over Time\",\n  treatmentPlanSummary: \"Treatment Plan Summary\",\n  surgicalTreatments: \"Surgical Treatments\",\n  radiationTreatments: \"Radiation Treatments\",\n  latestCtChest: \"Latest CT Chest\",\n  latestPetCt: \"Latest PET/CT\",\n  latestBrainMri: \"Latest Brain MRI\",\n  newLesions: \"New Lesions\",\n  radiologyImpressionKeywords: \"Radiology Impression Keywords\",\n  renalDysfunctionFlag: \"Renal Dysfunction Flag\",\n  liverDysfunctionFlag: \"Liver Dysfunction Flag\",\n  cbcValues: \"CBC Values\",\n  cmpValues: \"CMP Values\",\n  electrolytes: \"Electrolytes\",\n  abnormalLabFlags: \"Abnormal Lab Flags\",\n  longitudinalLaboratoryFlagTrends: \"Longitudinal Laboratory Flag Trends\",\n  overallDiseaseCourseSummary: \"Overall Disease Course Summary\",\n  stageChangesOverTime: \"Stage Changes Over Time\",\n  lastClinicalEncounterDate: \"Last Clinical Encounter Date\",\n  pathologyReportLinks: \"Pathology Report Links (Raw)\",\n  genomicReportLinks: \"Genomic Report Links (Raw)\",\n  radiologyReportLinks: \"Radiology Report Links (Raw)\",\n  providerNoteLinks: \"Provider Note Links (Raw)\",\n  currentLineOfTherapy: \"Current Line of Therapy\",\n  priorTherapies: \"Prior Therapies\",\n  regimenDetails: \"Regimen Details\",\n  treatmentStartAndEndDates: \"Treatment Start and End Dates\",\n  responsePerLine: \"Response per Line\",\n  treatmentResponseTimeline: \"Treatment Response Timeline\",\n  reasonsForTreatmentChange: \"Reasons for Treatment Change\",\n  treatmentRelatedToxicities: \"Treatment-related Toxicities\",\n  radiologyTrend: \"Radiology Trend\",\n  radiologyTrendsOverTime: \"Radiology Trends Over Time\",\n  recistMeasurements: \"RECIST Measurements\",\n  lesionCountSize: \"Lesion Count / Size\",\n  cea: \"CEA\",\n  ca199: \"CA19-9\",\n  otherTumorMarkers: \"Other Tumor Markers\",\n  longitudinalBiomarkerTrends: \"Longitudinal Biomarker Trends\",\n  biomarkerTrendsOverTime: \"Biomarker Trends Over Time\",\n  treatmentTimeline: \"Treatment Timeline\",\n  tumorSizeTrend: \"Tumor Size Trend\",\n  biomarkerTrend: \"Biomarker Trend\",\n  pathologyDetails: \"Pathology Details (Structured)\",\n  pathologyReports: \"Pathology Reports\",\n  genomicReports: \"Genomic Reports\",\n  radiologyReports: \"Radiology Reports\",\n  providerNotes: \"Provider Notes\",\n  unlabeledColumn: \"Unlabeled Column\",\n};\n\nconst formatValue = (value: unknown): string => {\n  if (value === null || value === undefined || value === \"\") return \"—\";\n  if (typeof value === \"boolean\") return value ? \"Yes\" : \"No\";\n  if (Array.isArray(value)) return `${value.length} item(s)`;\n  return String(value);\n};\n\nexport function PatientInspector({ patients, analyzePatient }: PatientInspectorProps) {\n  const [selectedId, setSelectedId] = useState(patients[0]?.patientId ?? \"\");\n  const [insights, setInsights] = useState<MasterAIResponse | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [isPending, startTransition] = useTransition();\n\n  const patient = useMemo(\n    () => patients.find((p) => p.patientId === selectedId) ?? patients[0],\n    [patients, selectedId],\n  );\n\n  const fetchInsights = useCallback(\n    async (target: Patient) => {\n      try {\n        const result = await analyzePatient(target);\n        setInsights(result);\n        setError(null);\n      } catch (err) {\n        console.error(err);\n        setError(\n          err instanceof Error\n            ? err.message\n            : \"Unable to generate insights. Check server logs for details.\",\n        );\n      }\n    },\n    [analyzePatient],\n  );\n\n  useEffect(() => {\n    if (!patient) return;\n    setInsights(null);\n    setError(null);\n    startTransition(() => {\n      void fetchInsights(patient);\n    });\n  }, [patient, fetchInsights]);\n\n  const handleGenerateInsights = () => {\n    if (!patient) return;\n    startTransition(() => {\n      void fetchInsights(patient);\n    });\n  };\n\n  if (!patients.length) {\n    return (\n      <div className=\"rounded border border-dashed border-red-300 bg-red-50 p-4 text-sm text-red-700\">\n        No patient data found. Ensure the CSV exists at <code>public/data/params_onco_final.csv</code>.\n      </div>\n    );\n  }\n\n  const scalarEntries = Object.entries(patient ?? {}).filter(\n    ([key]) => !COMPLEX_FIELDS.includes(key as keyof Patient),\n  );\n\n  return (\n    <section className=\"space-y-10\">\n      <div className=\"space-y-3\">\n        <label className=\"text-sm font-medium text-slate-700\" htmlFor=\"patient-select\">\n          Select Patient ID\n        </label>\n        <select\n          id=\"patient-select\"\n          className=\"w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-base text-slate-900 shadow-sm focus:border-slate-500 focus:outline-none focus:ring-1 focus:ring-slate-500 sm:max-w-xs\"\n          value={selectedId}\n          onChange={(event) => setSelectedId(event.target.value)}\n        >\n          {patients.map((p) => (\n            <option key={p.patientId} value={p.patientId}>\n              {p.patientId} — {p.name}\n            </option>\n          ))}\n        </select>\n      </div>\n\n      {patient && (\n        <div className=\"space-y-8\">\n          <div>\n            <h2 className=\"text-xl font-semibold text-slate-900\">\n              {patient.patientId}: {patient.name}\n            </h2>\n            <p className=\"text-sm text-slate-500\">\n              Total fields loaded: {scalarEntries.length + COMPLEX_FIELDS.length}\n            </p>\n          </div>\n\n          <div className=\"grid gap-4 md:grid-cols-2\">\n            {scalarEntries.map(([key, value]) => {\n              const typedKey = key as keyof Patient;\n              const label = FIELD_LABELS[typedKey] ?? key;\n              return (\n                <div\n                  key={key}\n                  className=\"rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm shadow-sm\"\n                >\n                  <p className=\"text-xs uppercase tracking-wide text-slate-500\">{label}</p>\n                  <p className=\"mt-2 text-base font-medium text-slate-900\">{formatValue(value)}</p>\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"space-y-6\">\n            {COMPLEX_FIELDS.map((key) => (\n              <div key={key} className=\"space-y-2\">\n                <p className=\"text-sm font-semibold uppercase tracking-wide text-slate-600\">\n                  {FIELD_LABELS[key]}\n                </p>\n                <pre className=\"bg-slate-950 text-green-400 p-4 rounded-lg overflow-auto text-xs\">\n                  {JSON.stringify(patient[key], null, 2)}\n                </pre>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      <div className=\"space-y-4 rounded-xl border border-slate-200 bg-white/80 p-5 shadow-inner\">\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n          <div>\n            <p className=\"text-sm uppercase tracking-wide text-slate-500\">Gemini Master Layer</p>\n            <h3 className=\"text-lg font-semibold text-slate-900\">AI Insights</h3>\n          </div>\n          <button\n            type=\"button\"\n            onClick={handleGenerateInsights}\n            disabled={isPending || !patient}\n            className=\"inline-flex items-center justify-center rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:bg-slate-400\"\n          >\n            {isPending ? \"Generating…\" : \"Generate Insights\"}\n          </button>\n        </div>\n\n        {error && (\n          <div className=\"rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700\">\n            {error}\n          </div>\n        )}\n\n        {insights ? (\n          <pre className=\"bg-slate-950 text-green-400 p-4 rounded-lg overflow-auto text-xs\">\n            {JSON.stringify(insights, null, 2)}\n          </pre>\n        ) : (\n          <p className=\"text-sm text-slate-500\">\n            Run the Gemini action to view the structured intelligence schema.\n          </p>\n        )}\n      </div>\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/sidebar-intelligence.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/context-tab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/design-system.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/diagnosis-tab.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CARD_TITLE' is defined but never used.","line":7,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Activity, AlertTriangle, ArrowRight, Dna, Pill, TrendingUp, XCircle } from \"lucide-react\";\n\nimport type { MasterAIResponse } from \"@/types/patient-insights\";\nimport type { Patient } from \"@/types/patient\";\nimport { BADGE, BODY_TEXT, CARD, CARD_TITLE, LABEL_TEXT, SECTION_HEADER } from \"./design-system\";\n\ninterface DiagnosisTabProps {\n  patient: Patient;\n  aiInsights?: MasterAIResponse | null;\n}\n\ntype TreatmentLine = {\n  lineLabel: string;\n  regimen: string;\n  startDate: string;\n  endDate: string;\n  response: string;\n  status?: string;\n  reasonStopped?: string;\n  toxicities?: string;\n  isCurrent?: boolean;\n};\n\nconst MOCK_DATA = {\n  metastaticSites: [\"Brain\", \"Liver\", \"Bone\"],\n  aiInsights: {\n    diseaseTrajectory: \"Rapid progression\",\n  },\n  treatmentHistory: [\n    {\n      lineLabel: \"Line 1\",\n      regimen: \"Osimertinib 80mg PO Daily\",\n      startDate: \"Feb 2023\",\n      endDate: \"Ongoing\",\n      response: \"PR\",\n      status: \"Active\",\n      isCurrent: true,\n    },\n    {\n      lineLabel: \"Line 2\",\n      regimen: \"Carbo/Pem/Pembro\",\n      startDate: \"Jun 2022\",\n      endDate: \"Jan 2023\",\n      response: \"SD\",\n      status: \"Ended\",\n      reasonStopped: \"Progression\",\n    },\n    {\n      lineLabel: \"Line 3\",\n      regimen: \"Docetaxel + Ramucirumab\",\n      startDate: \"Jan 2021\",\n      endDate: \"May 2022\",\n      response: \"PD\",\n      status: \"Ended\",\n      reasonStopped: \"Toxicity\",\n    },\n  ] satisfies TreatmentLine[],\n};\n\nconst parsePercent = (input?: string | null): number | null => {\n  if (!input) return null;\n  const match = input.match(/([-+]?\\d*\\.?\\d+)/);\n  if (!match) return null;\n  const value = Number.parseFloat(match[1]);\n  return Number.isFinite(value) ? Math.max(0, Math.min(100, value)) : null;\n};\n\nconst parseTmb = (input?: string | null): string => input?.trim() || \"Not reported\";\n\nconst formatMetastaticSites = (patient: Patient) => {\n  const legacyArray = (patient as Patient & { metastatic_sites?: string[] }).metastatic_sites;\n  if (legacyArray && legacyArray.length) return legacyArray;\n\n  const fromString = patient.metastaticSites\n    ?.split(/[,;]/)\n    .map((value) => value.trim())\n    .filter(Boolean);\n\n  if (fromString && fromString.length) return fromString;\n\n  return MOCK_DATA.metastaticSites;\n};\n\nconst getDriverMutation = (patient: Patient) => {\n  const genomics = (patient as Patient & { genomics?: string }).genomics;\n  if (genomics?.trim()) {\n    return genomics.trim();\n  }\n  if (patient.actionableMutationSummary?.trim()) {\n    return patient.actionableMutationSummary.trim();\n  }\n\n  const candidate =\n    patient.egfrMutation ||\n    patient.alkRearrangement ||\n    patient.ros1Rearrangement ||\n    patient.krasMutation ||\n    patient.brafMutation;\n\n  return candidate?.trim() || null;\n};\n\nconst normalizeEndStatus = (value?: string | null) => {\n  if (!value) return { label: \"Ongoing\", ended: false };\n  const trimmed = value.trim();\n  if (!trimmed || /ongoing|current|active/i.test(trimmed)) {\n    return { label: \"Ongoing\", ended: false };\n  }\n  return { label: trimmed, ended: true };\n};\n\nconst getTreatmentHistory = (patient: Patient): TreatmentLine[] => {\n  const explicitHistory = (\n    patient as Patient & {\n      treatment_history?: Array<\n        TreatmentLine & {\n          reason_stopped?: string;\n          toxicities?: string;\n        }\n      >;\n    }\n  ).treatment_history;\n  if (explicitHistory?.length) {\n    return explicitHistory.map((line) => ({\n      ...line,\n      reasonStopped: line.reasonStopped || line.reason_stopped,\n      toxicities: line.toxicities,\n    }));\n  }\n\n  if (patient.treatmentTimeline?.length) {\n    return patient.treatmentTimeline.map((event, index) => {\n      const extendedEvent = event as {\n        reasonForStopping?: string;\n        reason_for_stopping?: string;\n        toxicities?: string;\n        treatmentRelatedToxicities?: string;\n      };\n      const endMeta = normalizeEndStatus(event.endDate);\n      return {\n        lineLabel: event.line ? `Line ${event.line}` : `Line ${index + 1}`,\n        regimen: event.regimen || event.response || \"Regimen not documented\",\n        startDate: event.startDate || \"Start N/A\",\n        endDate: endMeta.label,\n        response: event.response || \"ND\",\n        status: endMeta.ended ? \"Ended\" : \"Active\",\n        isCurrent: !endMeta.ended,\n        reasonStopped: extendedEvent.reasonForStopping || extendedEvent.reason_for_stopping,\n        toxicities: extendedEvent.toxicities || extendedEvent.treatmentRelatedToxicities,\n      };\n    });\n  }\n\n  return MOCK_DATA.treatmentHistory;\n};\n\nconst pillTone = (value: number | null) => {\n  if (value === null) return \"text-slate-600 bg-slate-100\";\n  if (value >= 50) return \"text-emerald-900 bg-emerald-100\";\n  if (value >= 1) return \"text-amber-900 bg-amber-100\";\n  return \"text-slate-700 bg-slate-100\";\n};\n\nconst responseTone = (response: string) => {\n  const normalized = response?.toLowerCase() ?? \"\";\n  if (normalized.includes(\"cr\") || normalized.includes(\"pr\")) {\n    return \"text-emerald-600\";\n  }\n  if (normalized.includes(\"pd\")) {\n    return \"text-rose-600\";\n  }\n  if (normalized.includes(\"sd\")) {\n    return \"text-amber-600\";\n  }\n  return \"text-slate-500\";\n};\n\nconst STATUS_TONE_DEFAULT = {\n  text: \"text-slate-700\",\n  badge: \"border border-slate-200 bg-slate-50 text-slate-700\",\n  border: \"border-slate-200\",\n  icon: \"text-slate-500\",\n};\n\nconst statusTone = (value?: string | null) => {\n  const normalized = value?.toLowerCase() ?? \"\";\n  if (/progress|pd/.test(normalized)) {\n    return {\n      text: \"text-rose-700\",\n      badge: \"border border-rose-200 bg-rose-50 text-rose-700\",\n      border: \"border-rose-200 bg-rose-50/40\",\n      icon: \"text-rose-600\",\n    };\n  }\n  if (/stable|sd/.test(normalized)) {\n    return {\n      text: \"text-amber-700\",\n      badge: \"border border-amber-200 bg-amber-50 text-amber-800\",\n      border: \"border-amber-200 bg-amber-50/40\",\n      icon: \"text-amber-600\",\n    };\n  }\n  if (/response|pr|cr/.test(normalized)) {\n    return {\n      text: \"text-emerald-700\",\n      badge: \"border border-emerald-200 bg-emerald-50 text-emerald-700\",\n      border: \"border-emerald-200 bg-emerald-50/40\",\n      icon: \"text-emerald-600\",\n    };\n  }\n  return STATUS_TONE_DEFAULT;\n};\n\nconst recurrenceBadge = (status?: string | null) => {\n  const normalized = status?.toLowerCase() ?? \"\";\n  if (!normalized) {\n    return { label: \"Status Unknown\", classes: \"bg-slate-100 text-slate-600\" };\n  }\n  if (normalized.includes(\"recur\") || normalized.includes(\"relap\") || normalized.includes(\"progression\")) {\n    return { label: status, classes: \"bg-rose-100 text-rose-700\" };\n  }\n  return { label: status, classes: \"bg-blue-100 text-blue-700\" };\n};\n\nconst discontinuationMeta = (reason?: string) => {\n  const normalized = reason?.toLowerCase() ?? \"\";\n  if (!normalized) {\n    return {\n      icon: AlertTriangle,\n      classes: \"text-slate-500\",\n    };\n  }\n  if (normalized.includes(\"progress\")) {\n    return {\n      icon: AlertTriangle,\n      classes: \"text-rose-600\",\n    };\n  }\n  if (normalized.includes(\"tox\") || normalized.includes(\"ae\") || normalized.includes(\"immune\")) {\n    return {\n      icon: XCircle,\n      classes: \"text-amber-600\",\n    };\n  }\n  return {\n    icon: AlertTriangle,\n    classes: \"text-slate-500\",\n  };\n};\n\nconst stageRank = (stage?: string | null): number | null => {\n  if (!stage) return null;\n  const match = stage.match(/stage\\s*([0-9ivx]+)/i);\n  if (match) {\n    const token = match[1].toUpperCase();\n    const romanMap: Record<string, number> = { \"0\": 0, I: 1, II: 2, III: 3, IV: 4 };\n    if (romanMap[token]) return romanMap[token];\n    const numeric = Number.parseInt(token, 10);\n    if (Number.isFinite(numeric)) return numeric;\n  }\n  const fallbackMatch = stage.match(/([IVX]+)(?:\\w+)?/i);\n  if (fallbackMatch) {\n    const token = fallbackMatch[1].toUpperCase();\n    const romanMap: Record<string, number> = { I: 1, II: 2, III: 3, IV: 4 };\n    if (romanMap[token]) return romanMap[token];\n  }\n  return null;\n};\n\nconst hasMetastasis = (stage?: string | null) => {\n  if (!stage) return false;\n  return /M1|Stage\\s*IV|metastatic/i.test(stage);\n};\n\nconst buildTrajectorySummary = (initialStage?: string | null, currentStage?: string | null) => {\n  const initialRank = stageRank(initialStage);\n  const currentRank = stageRank(currentStage);\n  if (initialRank !== null && currentRank !== null) {\n    if (currentRank > initialRank) {\n      return \"Disease Progression\";\n    }\n    if (currentRank < initialRank) {\n      return \"Partial Response\";\n    }\n  }\n\n  const initialMet = hasMetastasis(initialStage);\n  const currentMet = hasMetastasis(currentStage);\n  if (!initialMet && currentMet) {\n    return \"Metastatic Recurrence\";\n  }\n\n  if (initialRank !== null && currentRank !== null && currentRank === initialRank) {\n    return \"Stable Disease\";\n  }\n\n  return null;\n};\n\nexport function DiagnosisTab({ patient, aiInsights }: DiagnosisTabProps) {\n  const driverMutation = getDriverMutation(patient);\n  const pdL1Percent = parsePercent(patient.pdL1Expression);\n  const tmbDisplay = parseTmb(patient.tumorMutationalBurden);\n  const msiDisplay = patient.microsatelliteInstability?.trim() || \"Not reported\";\n  const metastaticSites = formatMetastaticSites(patient);\n  const treatmentHistory = getTreatmentHistory(patient);\n  const rawInsights = (\n    patient as Patient & {\n      aiInsights?: {\n        diseaseTrajectory?: string;\n        disease_trajectory?: string;\n        diagnosis?: {\n          staging_summary?: string;\n        };\n      };\n    }\n  ).aiInsights;\n  const stages = {\n    initial: patient.initialTnmStage || \"Unknown\",\n    current: patient.currentTnmStage || patient.initialTnmStage || \"Unknown\",\n  };\n  const aiStagingSummary = rawInsights?.diagnosis?.staging_summary?.trim();\n  const computedSummary =\n    aiStagingSummary ||\n    rawInsights?.diseaseTrajectory ||\n    rawInsights?.disease_trajectory ||\n    buildTrajectorySummary(stages.initial, stages.current) ||\n    null;\n  const recurrence = recurrenceBadge(patient.recurrenceStatus);\n\n  const aiStatus = aiInsights?.current_status_summary?.trim();\n  const fallbackStatus =\n    patient.responsePerLine ||\n    (patient as Patient & { response_per_line?: string }).response_per_line ||\n    \"\";\n  const tone = statusTone(aiStatus || fallbackStatus || \"\");\n\n  return (\n    <div className=\"space-y-6\">\n      <section className={CARD}>\n        <div className=\"flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between\">\n          <div className=\"space-y-2\">\n            <p className={SECTION_HEADER}>Clinical Identity</p>\n            <h2 className=\"text-lg font-semibold text-slate-900\">\n              {patient.primaryDiagnosis || \"Primary diagnosis not documented\"}\n            </h2>\n            <p className={BODY_TEXT}>\n              {patient.histologicType || \"Histology not documented\"}{\" \"}\n              {patient.tumorGrade ? `• Grade ${patient.tumorGrade}` : null}\n            </p>\n            <div\n              className={`mt-3 flex items-start gap-3 rounded-xl border bg-white px-4 py-3 ${tone.border}`}\n            >\n              <TrendingUp className={`h-5 w-5 ${tone.icon}`} />\n              <div>\n                <p className={`${LABEL_TEXT} mb-1 text-xs`}>Current disease status</p>\n                {aiStatus ? (\n                  <p className={`text-sm font-medium ${tone.text}`}>{aiStatus}</p>\n                ) : fallbackStatus ? (\n                  <span className={`${BADGE} ${tone.badge}`}>{fallbackStatus}</span>\n                ) : (\n                  <p className={LABEL_TEXT}>Status not documented.</p>\n                )}\n              </div>\n            </div>\n          </div>\n\n          <div className=\"w-full max-w-xl space-y-4 rounded-xl border border-slate-100 bg-slate-50 p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500\">\n                <Dna className=\"h-4 w-4\" />\n                Driver Mutation\n              </div>\n              {!driverMutation && <span className={LABEL_TEXT}>Awaiting sequencing</span>}\n            </div>\n            <div\n              className={`${BADGE} ${\n                driverMutation ? \"bg-emerald-50 text-emerald-700\" : \"border border-dashed border-slate-300 text-slate-600\"\n              }`}\n            >\n              {driverMutation || \"No actionable driver detected\"}\n            </div>\n\n            <div className=\"flex flex-wrap gap-2\">\n              <span className={`${BADGE} ${pillTone(pdL1Percent)}`}>\n                PD-L1 TPS: {pdL1Percent !== null ? `${pdL1Percent}%` : \"Not reported\"}\n              </span>\n              <span className={`${BADGE} bg-slate-100 text-slate-700`}>TMB: {tmbDisplay}</span>\n              <span className={`${BADGE} bg-slate-100 text-slate-700`}>MSI: {msiDisplay}</span>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section className=\"grid gap-6 lg:grid-cols-2\">\n        <div className={CARD}>\n          <div className=\"flex items-center gap-3\">\n            <Activity className=\"h-5 w-5 text-slate-500\" />\n            <p className={SECTION_HEADER}>Metastatic Spread & Status</p>\n          </div>\n          <div className=\"mt-5 space-y-4\">\n            <span className={`${BADGE} ${recurrence.classes}`}>{recurrence.label}</span>\n\n            <div className=\"space-y-2\">\n              <p className={LABEL_TEXT}>Metastatic Sites</p>\n              <div className=\"flex flex-wrap gap-2\">\n                {metastaticSites.length ? (\n                  metastaticSites.map((site, idx) => (\n                    <span key={`${site}-${idx}`} className={`${BADGE} border border-slate-200 text-slate-700`}>\n                      {site}\n                    </span>\n                  ))\n                ) : (\n                  <span className={BODY_TEXT}>No distant metastasis documented.</span>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div className={CARD}>\n          <div className=\"flex items-center gap-3\">\n            <ArrowRight className=\"h-5 w-5 text-slate-500\" />\n            <p className={SECTION_HEADER}>Staging Trajectory</p>\n          </div>\n          <div className=\"mt-6 flex flex-col gap-4 text-center sm:flex-row sm:items-center sm:justify-between\">\n            <div>\n              <p className={LABEL_TEXT}>Initial</p>\n              <p className=\"mt-1 text-lg font-semibold text-slate-900\">{stages.initial}</p>\n            </div>\n            <div className=\"inline-flex flex-col items-center gap-2\">\n              <ArrowRight className=\"h-5 w-5 text-slate-400\" />\n              <span\n                className={`${BADGE} ${\n                  computedSummary ? \"bg-slate-900 text-white\" : \"bg-slate-200 text-slate-500 animate-pulse\"\n                }`}\n              >\n                {computedSummary || \"Analyzing trajectory...\"}\n              </span>\n            </div>\n            <div>\n              <p className={LABEL_TEXT}>Current</p>\n              <p className=\"mt-1 text-lg font-semibold text-slate-900\">{stages.current}</p>\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section className={CARD}>\n        <p className={SECTION_HEADER}>Therapeutic Timeline</p>\n        <div className=\"space-y-4\">\n          {treatmentHistory.map((line, idx) => (\n            <div\n              key={`${line.lineLabel}-${idx}`}\n              className={`rounded-xl border border-slate-200 px-4 py-4 ${\n                line.isCurrent ? \"bg-slate-50\" : \"bg-white\"\n              }`}\n            >\n              <div className=\"flex flex-wrap items-center gap-3\">\n                <span className={`${BADGE} bg-slate-900 text-white`}>\n                  {line.lineLabel}\n                </span>\n                <div className=\"flex items-center gap-2 text-sm font-semibold text-slate-900\">\n                  <Pill className=\"h-4 w-4 text-slate-500\" />\n                  {line.regimen}\n                  {line.isCurrent && (\n                    <span className={`${BADGE} flex items-center gap-1 bg-emerald-50 text-emerald-700`}>\n                      <span className=\"h-2 w-2 animate-pulse rounded-full bg-emerald-500\" />\n                      Active\n                    </span>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"mt-3 flex flex-wrap items-center gap-6 text-xs font-semibold uppercase tracking-wide text-slate-500\">\n                <span>\n                  Dates:{\" \"}\n                  <span className=\"text-slate-900 normal-case tracking-normal text-sm font-medium\">\n                    {line.startDate} — {line.endDate}\n                  </span>\n                </span>\n                <span>\n                  Response:{\" \"}\n                  <span className={`text-sm font-semibold normal-case tracking-normal ${responseTone(line.response)}`}>\n                    {line.response || \"Not documented\"}\n                  </span>\n                </span>\n              </div>\n              {line.toxicities && (\n                <div className=\"mt-3 flex items-start gap-2 rounded-lg bg-slate-50 px-3 py-2 text-sm text-slate-700\">\n                  <Activity className=\"mt-0.5 h-4 w-4 text-slate-500\" />\n                  <span>Toxicities: {line.toxicities}</span>\n                </div>\n              )}\n              {line.status?.toLowerCase() === \"ended\" && line.reasonStopped && (\n                <div className=\"mt-3 flex items-center gap-2 rounded-lg bg-rose-50 px-3 py-2 text-sm font-semibold text-rose-700\">\n                  {(() => {\n                    const meta = discontinuationMeta(line.reasonStopped);\n                    const Icon = meta.icon;\n                    return <Icon className={`h-4 w-4 ${meta.classes}`} />;\n                  })()}\n                  <span className={discontinuationMeta(line.reasonStopped).classes}>\n                    Discontinued due to: {line.reasonStopped}\n                  </span>\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      </section>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/investigations-tab.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Activity' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileImage' is defined but never used.","line":5,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Area' is defined but never used.","line":8,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":7},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AreaChart' is defined but never used.","line":9,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CartesianGrid' is defined but never used.","line":10,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ResponsiveContainer' is defined but never used.","line":11,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tooltip' is defined but never used.","line":12,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'XAxis' is defined but never used.","line":13,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'YAxis' is defined but never used.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":8},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MARKER_PRIORITY' is assigned a value but never used.","line":32,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatDate' is assigned a value but never used.","line":53,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":53,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'LabsTooltip' is assigned a value but never used.","line":101,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2874,2877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2874,2877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TAB_SHORTCUTS' is assigned a value but never used.","line":115,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'molecularMap' is assigned a value but never used.","line":124,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":124,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'radiologyReports' is assigned a value but never used.","line":126,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":126,"endColumn":25},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/a38371/Desktop/onco/src/components/tabs/investigations-tab.tsx:133:5\n  131 |\n  132 |   useEffect(() => {\n> 133 |     setInternalPanel(\"pathology\");\n      |     ^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  134 |   }, [patient.patientId]);\n  135 |\n  136 |   const panelValue = activePanel ?? internalPanel;","line":133,"column":5,"nodeType":null,"endLine":133,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'hasBiomarkerTrend' is assigned a value but never used.","line":147,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":147,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'biomarkerName' is assigned a value but never used.","line":148,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":148,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'latestRadiologyText' is assigned a value but never used.","line":149,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":149,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentValue' is assigned a value but never used.","line":154,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":154,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'peakValue' is assigned a value but never used.","line":155,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":155,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'lowestValue' is assigned a value but never used.","line":158,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":158,"endColumn":20}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport * as Tabs from \"@radix-ui/react-tabs\";\nimport { motion } from \"framer-motion\";\nimport { Activity, FileImage } from \"lucide-react\";\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  Area,\n  AreaChart,\n  CartesianGrid,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\n\nimport type { BiomarkerPoint, Patient, RadiologyDocument } from \"@/types/patient\";\nimport type { MasterAIResponse } from \"@/types/patient-insights\";\nimport { PathologyView } from \"./investigations/pathology-view\";\nimport { RadiologyView } from \"./investigations/radiology-view\";\nimport { LabsView } from \"./investigations/labs-view\";\n\ntype InvestigationsPanel = \"pathology\" | \"radiology\" | \"laboratory\";\n\ninterface InvestigationsTabProps {\n  patient: Patient;\n  aiInsights?: MasterAIResponse | null;\n  activePanel?: InvestigationsPanel;\n  onPanelChange?: (panel: InvestigationsPanel) => void;\n}\n\nconst MARKER_PRIORITY = [\"ER\", \"PR\", \"HER2\", \"KI-67\", \"PD-L1\"];\n\nconst parseMarkerMap = (raw?: string | null) => {\n  if (!raw) return new Map<string, string>();\n\n  const tokens = raw.split(/[,;]+/).map((segment) => segment.trim());\n  const entries = tokens\n    .map((token) => {\n      if (!token) return null;\n      const match = token.match(/^(.*?)\\s*[:=]\\s*(.+)$/);\n      if (match) {\n        return [match[1].trim().toUpperCase(), match[2].trim()];\n      }\n      const shorthand = token.split(/\\s+/)[0]?.trim()?.toUpperCase();\n      return shorthand ? [shorthand, token] : null;\n    })\n    .filter(Boolean) as [string, string][];\n\n  return new Map(entries);\n};\n\nconst formatDate = (date?: string) => {\n  if (!date) return \"—\";\n  try {\n    return new Intl.DateTimeFormat(\"en\", { month: \"short\", day: \"numeric\", year: \"numeric\" }).format(\n      new Date(date),\n    );\n  } catch {\n    return date;\n  }\n};\n\nconst parseBiomarkerTrend = (trend?: BiomarkerPoint[] | string | null): BiomarkerPoint[] => {\n  if (!trend) return [];\n  if (Array.isArray(trend)) {\n    return trend.filter((point) => typeof point.value === \"number\" && !!point.date);\n  }\n\n  try {\n    const parsed = JSON.parse(trend) as unknown;\n    if (Array.isArray(parsed)) {\n      return parsed.filter((point): point is BiomarkerPoint => {\n        return (\n          point &&\n          typeof point === \"object\" &&\n          typeof point.date === \"string\" &&\n          typeof point.value === \"number\"\n        );\n      });\n    }\n  } catch {\n    return [];\n  }\n\n  return [];\n};\n\nconst normalizeRadiologyReports = (reports?: RadiologyDocument[]) => {\n  if (!Array.isArray(reports)) return [];\n\n  return [...reports]\n    .filter((report) => report.date || report.modality || report.summary)\n    .sort((a, b) => {\n      const da = a.date ? Date.parse(a.date) : 0;\n      const db = b.date ? Date.parse(b.date) : 0;\n      return db - da;\n    });\n};\n\nconst LabsTooltip = ({ active, payload, label }: any) => {\n  if (!active || !payload?.length) return null;\n\n  const point = payload[0];\n  return (\n    <div className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 shadow-lg\">\n      <p className=\"text-xs font-semibold text-slate-500\">{label}</p>\n      <p className=\"text-sm font-semibold text-slate-900\">\n        {point.value} {point.payload.unit ?? \"\"}\n      </p>\n    </div>\n  );\n};\n\nconst TAB_SHORTCUTS: { combo: string[]; target: string }[] = [\n  { combo: [\"o\", \"p\"], target: \"patient\" },\n  { combo: [\"o\", \"d\"], target: \"diagnosis\" },\n  { combo: [\"o\", \"i\"], target: \"pathology\" },\n  { combo: [\"o\", \"r\"], target: \"radiology\" },\n  { combo: [\"o\", \"l\"], target: \"laboratory\" },\n];\n\nexport function InvestigationsTab({ patient, aiInsights, activePanel, onPanelChange }: InvestigationsTabProps) {\n  const molecularMap = useMemo(() => parseMarkerMap(patient.ihcMarkers), [patient.ihcMarkers]);\n  const biomarkerSeries = useMemo(() => parseBiomarkerTrend(patient.biomarkerTrend), [patient]);\n  const radiologyReports = useMemo(\n    () => normalizeRadiologyReports(patient.radiologyReports),\n    [patient.radiologyReports],\n  );\n  const [internalPanel, setInternalPanel] = useState<InvestigationsPanel>(\"pathology\");\n\n  useEffect(() => {\n    setInternalPanel(\"pathology\");\n  }, [patient.patientId]);\n\n  const panelValue = activePanel ?? internalPanel;\n\n  const handleTabChange = (value: string) => {\n    const cast = value as InvestigationsPanel;\n    if (onPanelChange) {\n      onPanelChange(cast);\n    } else {\n      setInternalPanel(cast);\n    }\n  };\n\n  const hasBiomarkerTrend = biomarkerSeries.length >= 2;\n  const biomarkerName = biomarkerSeries[0]?.markerName ?? \"Biomarker\";\n  const latestRadiologyText =\n    patient.radiologyTrend ||\n    patient.radiologyImpressionKeywords ||\n    patient.latestCtChest ||\n    \"No radiology summary provided.\";\n  const currentValue = biomarkerSeries.at(-1)?.value ?? null;\n  const peakValue = biomarkerSeries.length\n    ? Math.max(...biomarkerSeries.map((point) => point.value ?? Number.NEGATIVE_INFINITY))\n    : null;\n  const lowestValue = biomarkerSeries.length\n    ? Math.min(...biomarkerSeries.map((point) => point.value ?? Number.POSITIVE_INFINITY))\n    : null;\n\n  return (\n    <div className=\"space-y-6\">\n      <motion.div\n        initial={{ opacity: 0, y: -12 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.35, ease: \"easeOut\" }}\n        className=\"rounded-3xl border border-slate-200/80 bg-white/95 p-4 shadow-sm\"\n      >\n        <Tabs.Root value={panelValue} onValueChange={handleTabChange} className=\"w-full\">\n          <Tabs.List className=\"grid h-12 w-full max-w-lg grid-cols-3 rounded-full bg-slate-100/80 p-1 text-sm font-semibold text-slate-500\">\n            <Tabs.Trigger\n              value=\"pathology\"\n              className=\"rounded-full px-4 py-2 data-[state=active]:bg-white data-[state=active]:text-slate-900 data-[state=active]:shadow-md\"\n            >\n              Pathology\n            </Tabs.Trigger>\n            <Tabs.Trigger\n              value=\"radiology\"\n              className=\"rounded-full px-4 py-2 data-[state=active]:bg-white data-[state=active]:text-slate-900 data-[state=active]:shadow-md\"\n            >\n              Radiology\n            </Tabs.Trigger>\n            <Tabs.Trigger\n              value=\"laboratory\"\n              className=\"rounded-full px-4 py-2 data-[state=active]:bg-white data-[state=active]:text-slate-900 data-[state=active]:shadow-md\"\n            >\n              Laboratory\n            </Tabs.Trigger>\n          </Tabs.List>\n\n          <div className=\"mt-6\">\n            <Tabs.Content value=\"pathology\" className=\"focus:outline-none\">\n              <PathologyView patient={patient} aiInsights={aiInsights} />\n            </Tabs.Content>\n\n            <Tabs.Content value=\"radiology\" className=\"space-y-6 focus:outline-none\">\n              <RadiologyView patient={patient} />\n            </Tabs.Content>\n\n            <Tabs.Content value=\"laboratory\" className=\"focus:outline-none\">\n              <LabsView patient={patient} aiInsights={aiInsights} />\n            </Tabs.Content>\n          </div>\n        </Tabs.Root>\n      </motion.div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/investigations/labs-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SOFT_CARD' is defined but never used.","line":17,"column":84,"nodeType":null,"messageId":"unusedVar","endLine":17,"endColumn":93},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2287,2290],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2287,2290],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/a38371/Desktop/onco/src/components/tabs/investigations/labs-view.tsx:144:5\n  142 |\n  143 |   useEffect(() => {\n> 144 |     setSelectedMarker(availableMarkers[0] ?? \"No data\");\n      |     ^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  145 |   }, [availableMarkers]);\n  146 |\n  147 |   const filteredSeries = biomarkerSeries.filter((point) => point.marker === selectedMarker);","line":144,"column":5,"nodeType":null,"endLine":144,"endColumn":22}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { AlertCircle, AlertTriangle, Droplet, FlaskConical, ThermometerSun } from \"lucide-react\";\nimport { useEffect, useMemo, useState } from \"react\";\nimport {\n  CartesianGrid,\n  Line,\n  LineChart,\n  ResponsiveContainer,\n  Tooltip,\n  XAxis,\n  YAxis,\n} from \"recharts\";\n\nimport type { Patient } from \"@/types/patient\";\nimport type { MasterAIResponse } from \"@/types/patient-insights\";\nimport { BADGE, BODY_TEXT, CARD, CARD_TITLE, GRID_GAP, LABEL_TEXT, SECTION_HEADER, SOFT_CARD } from \"../design-system\";\n\ntype BiomarkerTrendPoint = {\n  date?: string;\n  marker?: string;\n  value?: number | null;\n  unit?: string | null;\n};\n\nconst ABNORMAL_KEYWORDS = [\n  \"low\",\n  \"high\",\n  \"elevated\",\n  \"anemia\",\n  \"thrombocytopenia\",\n  \"leukopenia\",\n  \"hyponatremia\",\n  \"hyperkalemia\",\n  \"jaundice\",\n];\n\nconst isAbnormal = (value?: string | null) => {\n  if (!value) return false;\n  const normalized = value.toLowerCase();\n  return ABNORMAL_KEYWORDS.some((keyword) => normalized.includes(keyword));\n};\n\ninterface LabsViewProps {\n  patient: Patient;\n  aiInsights?: MasterAIResponse | null;\n}\n\nconst safeParseArray = <T,>(raw?: string | null): T[] => {\n  if (!raw) return [];\n  try {\n    const parsed = JSON.parse(raw) as unknown;\n    return Array.isArray(parsed) ? (parsed as T[]) : [];\n  } catch {\n    return [];\n  }\n};\n\nconst formatDate = (value?: string) => {\n  if (!value) return \"—\";\n  const timestamp = Date.parse(value);\n  if (Number.isNaN(timestamp)) return value;\n  return new Intl.DateTimeFormat(\"en\", { month: \"short\", day: \"numeric\", year: \"numeric\" }).format(\n    new Date(timestamp),\n  );\n};\n\nconst parseLabString = (raw?: string | null) => {\n  if (!raw) return [];\n  return raw\n    .split(/[\\n;,]+/)\n    .map((entry) => entry.trim())\n    .filter(Boolean)\n    .map((entry) => {\n      const match = entry.match(/^([^:=]+?)[\\s:=]+(.+)$/);\n      if (match) {\n        return {\n          label: match[1].trim(),\n          value: match[2].trim(),\n        };\n      }\n      const parts = entry.split(/\\s+/);\n      if (parts.length >= 2) {\n        return {\n          label: parts.slice(0, -1).join(\" \"),\n          value: parts.slice(-1)[0],\n        };\n      }\n      return {\n        label: entry,\n        value: \"\",\n      };\n    });\n};\n\nconst LabsChartTooltip = ({ active, payload }: any) => {\n  if (!active || !payload?.length) return null;\n  const point = payload[0];\n  return (\n    <div className=\"rounded-xl border border-slate-200 bg-white px-4 py-2 shadow-lg\">\n      <p className=\"text-xs font-semibold uppercase tracking-[0.3em] text-slate-400\">\n        {point.payload.formattedDate}\n      </p>\n      <p className=\"text-sm font-semibold text-slate-900\">\n        {point.value} {point.payload.unit ?? \"\"}\n      </p>\n    </div>\n  );\n};\n\nexport function LabsView({ patient, aiInsights }: LabsViewProps) {\n  const biomarkerTrendRaw = (patient as unknown as Record<string, string | undefined>)[\"Biomarker_Trend_JSON\"];\n  const abnormalFlagsRaw =\n    (patient as unknown as Record<string, string | undefined>)[\"Abnormal lab flags\"] || (patient as unknown as Record<string, string | undefined>)[\"abnormal_lab_flags\"];\n  const abnormalFlags =\n    abnormalFlagsRaw && abnormalFlagsRaw !== \"NaN\"\n      ? abnormalFlagsRaw\n          .split(/;+/)\n          .map((flag) => flag.trim())\n          .filter(Boolean)\n      : [];\n\n  const biomarkerSeries = useMemo(() => {\n    const parsed = safeParseArray<BiomarkerTrendPoint>(biomarkerTrendRaw);\n    if (parsed.length) {\n      return parsed.filter((point) => point.marker && typeof point.value === \"number\" && point.date);\n    }\n    return (patient.biomarkerTrend ?? []).map((point) => ({\n      date: point.date,\n      marker: point.markerName,\n      value: point.value,\n      unit: undefined,\n    }));\n  }, [biomarkerTrendRaw, patient.biomarkerTrend]);\n\n  const availableMarkers = useMemo(() => {\n    const unique = Array.from(new Set(biomarkerSeries.map((point) => point.marker).filter(Boolean))) as string[];\n    return unique.length ? unique : [\"No data\"];\n  }, [biomarkerSeries]);\n\n  const [selectedMarker, setSelectedMarker] = useState<string>(availableMarkers[0] ?? \"No data\");\n\n  useEffect(() => {\n    setSelectedMarker(availableMarkers[0] ?? \"No data\");\n  }, [availableMarkers]);\n\n  const filteredSeries = biomarkerSeries.filter((point) => point.marker === selectedMarker);\n  const hasTrend = filteredSeries.length >= 2;\n\n  const renalFlag =\n    typeof patient.renalDysfunctionFlag === \"boolean\"\n      ? patient.renalDysfunctionFlag\n      : Boolean((patient as unknown as Record<string, string | undefined>)[\"Renal dysfunction flag\"]?.match(/yes/i));\n  const liverFlag =\n    typeof patient.liverDysfunctionFlag === \"boolean\"\n      ? patient.liverDysfunctionFlag\n      : Boolean((patient as unknown as Record<string, string | undefined>)[\"Liver dysfunction flag\"]?.match(/yes/i));\n\n  const cbcEntries = parseLabString((patient as unknown as Record<string, string | undefined>)[\"CBC values\"] ?? patient.cbcValues);\n  const cmpEntries = parseLabString((patient as unknown as Record<string, string | undefined>)[\"CMP values\"] ?? patient.cmpValues);\n  const electrolyteEntries = parseLabString(\n    (patient as unknown as Record<string, string | undefined>)[\"Electrolytes\"] ?? patient.electrolytes,\n  );\n\n  const cea = patient.cea || (patient as unknown as Record<string, string | undefined>)[\"CEA\"] || \"—\";\n  const ca199 = patient.ca199 || (patient as unknown as Record<string, string | undefined>)[\"CA19-9\"] || \"—\";\n  const otherMarkers = patient.otherTumorMarkers || (patient as unknown as Record<string, string | undefined>)[\"Other tumor markers\"];\n\n  return (\n    <div className=\"space-y-6\">\n      {abnormalFlags.length > 0 && (\n        <section className={`${CARD} border-rose-100 bg-rose-50 text-rose-700`}>\n          <div className=\"flex items-start gap-3\">\n            <AlertTriangle className=\"mt-0.5 h-5 w-5\" />\n            <div>\n              <p className={SECTION_HEADER}>Critical lab alerts</p>\n              <div className=\"mt-2 flex flex-wrap gap-2\">\n                {abnormalFlags.map((flag, index) => (\n                  <span key={`${flag}-${index}`} className={`${BADGE} bg-rose-100 text-rose-700`}>\n                    {flag}\n                  </span>\n                ))}\n              </div>\n            </div>\n          </div>\n        </section>\n      )}\n\n      <div className={`grid ${GRID_GAP} lg:grid-cols-2`}>\n        <section className={CARD}>\n          <p className={SECTION_HEADER}>Organ Function</p>\n          <div className=\"mt-3 grid grid-cols-2 gap-3 text-sm\">\n            <div\n              className={`rounded-xl border px-3 py-2 ${renalFlag ? \"border-rose-200 bg-rose-50 text-rose-700\" : \"border-emerald-200 bg-emerald-50 text-emerald-700\"}`}\n            >\n              <p className={LABEL_TEXT}>Renal</p>\n              <div className=\"mt-1 flex items-center gap-2 font-semibold\">\n                {renalFlag ? <AlertTriangle className=\"h-4 w-4\" /> : <Droplet className=\"h-4 w-4\" />}\n                {renalFlag ? \"Dysfunction\" : \"Stable\"}\n              </div>\n            </div>\n            <div\n              className={`rounded-xl border px-3 py-2 ${liverFlag ? \"border-rose-200 bg-rose-50 text-rose-700\" : \"border-emerald-200 bg-emerald-50 text-emerald-700\"}`}\n            >\n              <p className={LABEL_TEXT}>Liver</p>\n              <div className=\"mt-1 flex items-center gap-2 font-semibold\">\n                {liverFlag ? <AlertTriangle className=\"h-4 w-4\" /> : <FlaskConical className=\"h-4 w-4\" />}\n                {liverFlag ? \"Dysfunction\" : \"Stable\"}\n              </div>\n            </div>\n          </div>\n        </section>\n\n        <section className={CARD}>\n          <p className={SECTION_HEADER}>Tumor Markers</p>\n          <div className=\"mt-4 flex gap-6 text-slate-900\">\n            <div>\n              <p className={LABEL_TEXT}>CEA</p>\n              <p className=\"mt-1 text-3xl font-semibold\">{cea || \"—\"}</p>\n            </div>\n            <div>\n              <p className={LABEL_TEXT}>CA19-9</p>\n              <p className=\"mt-1 text-3xl font-semibold\">{ca199 || \"—\"}</p>\n            </div>\n          </div>\n          {otherMarkers && (\n            <p className={`${LABEL_TEXT} mt-3`}>\n              Other markers: <span className=\"font-semibold text-slate-700\">{otherMarkers}</span>\n            </p>\n          )}\n        </section>\n      </div>\n\n      <section className={CARD}>\n        <p className={SECTION_HEADER}>AI Insight</p>\n        <p className={BODY_TEXT}>\n          {aiInsights?.investigations?.labs_summary ||\n            \"No AI metabolics summary generated yet. Labs will reflect deterministic values below.\"}\n        </p>\n      </section>\n\n      <section className={CARD}>\n        <div className=\"flex flex-wrap items-center justify-between gap-4\">\n          <div>\n            <p className={SECTION_HEADER}>Biomarker trajectory</p>\n            <p className={CARD_TITLE}>{selectedMarker}</p>\n          </div>\n          <div className=\"flex flex-wrap gap-2 rounded-full bg-slate-100 p-1 text-sm font-semibold text-slate-500\">\n            {availableMarkers.map((marker) => (\n              <button\n                key={marker}\n                type=\"button\"\n                onClick={() => setSelectedMarker(marker)}\n                className={`rounded-full px-3 py-1 transition ${\n                  marker === selectedMarker ? \"bg-white text-slate-900 shadow\" : \"hover:text-slate-900\"\n                }`}\n                disabled={marker === \"No data\"}\n              >\n                {marker}\n              </button>\n            ))}\n          </div>\n        </div>\n        <div className=\"mt-4 h-80\">\n          {hasTrend ? (\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\n              <LineChart\n                data={filteredSeries.map((point) => ({\n                  ...point,\n                  formattedDate: formatDate(point.date),\n                }))}\n                margin={{ left: 8, right: 8, top: 12, bottom: 0 }}\n              >\n                <CartesianGrid strokeDasharray=\"4 4\" stroke=\"#e2e8f0\" />\n                <XAxis dataKey=\"formattedDate\" stroke=\"#94a3b8\" tick={{ fill: \"#475569\", fontSize: 12 }} />\n                <YAxis stroke=\"#94a3b8\" tick={{ fill: \"#475569\", fontSize: 12 }} />\n                <Tooltip content={<LabsChartTooltip />} />\n                <Line\n                  type=\"monotone\"\n                  dataKey=\"value\"\n                  stroke=\"#4338ca\"\n                  strokeWidth={3}\n                  dot={{ r: 4, fill: \"#4338ca\" }}\n                  activeDot={{ r: 6 }}\n                />\n              </LineChart>\n            </ResponsiveContainer>\n          ) : (\n            <div className=\"flex h-full items-center justify-center rounded-2xl border border-dashed border-slate-300 bg-slate-50 text-sm text-slate-500\">\n              No longitudinal data available for {selectedMarker}.\n            </div>\n          )}\n        </div>\n      </section>\n\n      <section className={`grid ${GRID_GAP} lg:grid-cols-3`}>\n        <LabPanel title=\"Hematology · CBC\" icon={<ThermometerSun className=\"h-4 w-4\" />} entries={cbcEntries} />\n        <LabPanel title=\"Metabolic · CMP\" icon={<FlaskConical className=\"h-4 w-4\" />} entries={cmpEntries} />\n        <LabPanel title=\"Electrolytes\" icon={<Droplet className=\"h-4 w-4\" />} entries={electrolyteEntries} />\n      </section>\n    </div>\n  );\n}\n\ninterface LabPanelProps {\n  title: string;\n  icon: React.ReactNode;\n  entries: { label: string; value: string }[];\n}\n\nconst LabValue = ({ value }: { value: string }) => {\n  if (!value) {\n    return <span className=\"text-slate-400\">—</span>;\n  }\n  const abnormal = isAbnormal(value);\n  return (\n    <span className={`flex items-center gap-1 ${abnormal ? \"text-rose-600 font-medium\" : \"text-slate-700\"}`}>\n      {abnormal && <AlertCircle className=\"h-3 w-3\" />}\n      {value}\n    </span>\n  );\n};\n\nconst LabPanel = ({ title, icon, entries }: LabPanelProps) => {\n  return (\n    <div className={CARD}>\n      <div className=\"flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.35em] text-slate-500\">\n        {icon}\n        {title}\n      </div>\n      {entries.length ? (\n        <dl className=\"mt-4 space-y-2 text-sm\">\n          {entries.map((entry, index) => (\n            <div key={`${entry.label}-${index}`} className=\"flex items-baseline justify-between rounded-2xl bg-slate-50 px-3 py-2\">\n              <dt className=\"text-slate-500\">{entry.label}</dt>\n              <dd>\n                <LabValue value={entry.value} />\n              </dd>\n            </div>\n          ))}\n        </dl>\n      ) : (\n        <p className={BODY_TEXT}>No structured data provided.</p>\n      )}\n    </div>\n  );\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/investigations/pathology-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Microscope' is defined but never used.","line":4,"column":45,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":55},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\n/Users/a38371/Desktop/onco/src/components/tabs/investigations/pathology-view.tsx:544:5\n  542 |\n  543 |   useEffect(() => {\n> 544 |     setSelectedReportIndex(0);\n      |     ^^^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  545 |   }, [reports.length]);\n  546 |\n  547 |   const selectedReport = reports[selectedReportIndex] ?? reports[0];","line":544,"column":5,"nodeType":null,"endLine":544,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'aiNarrative' is assigned a value but never used.","line":564,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":564,"endColumn":20},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'aiDeltas' conditional could make the dependencies of useMemo Hook (at line 576) change on every render. Move it inside the useMemo callback. Alternatively, wrap the initialization of 'aiDeltas' in its own useMemo() Hook.","line":571,"column":9,"nodeType":"VariableDeclarator","endLine":571,"endColumn":85}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\nimport { AlertCircle, FileText, GitCompare, Microscope } from \"lucide-react\";\n\nimport type { MasterAIResponse, PathologyDelta } from \"@/types/patient-insights\";\nimport type { PathologyDetails, Patient } from \"@/types/patient\";\nimport {\n  BADGE,\n  BODY_TEXT,\n  CARD,\n  CARD_TITLE,\n  GRID_GAP,\n  LABEL_TEXT,\n  SECTION_HEADER,\n  SIDEBAR_WIDTH,\n  SOFT_CARD,\n} from \"../design-system\";\n\ninterface PathologyViewProps {\n  patient: Patient;\n  aiInsights?: MasterAIResponse | null;\n}\n\ninterface NormalizedReport {\n  id: string;\n  rawDate?: string;\n  dateLabel: string;\n  procedure?: string;\n  site?: string;\n  diagnosis?: string;\n  histotype?: string;\n  grade?: string;\n  tumorSize?: string;\n  margins?: string;\n  lvi?: string;\n  pni?: string;\n  lymphNodes?: string;\n  ihcPanel: Record<string, string>;\n}\n\nconst formatDateLabel = (value?: string) => {\n  if (!value) return \"Undated report\";\n  try {\n    return new Intl.DateTimeFormat(\"en\", {\n      month: \"short\",\n      day: \"numeric\",\n      year: \"numeric\",\n    }).format(new Date(value));\n  } catch {\n    return value;\n  }\n};\n\nconst buildComparisonInterpretation = (latest?: NormalizedReport, previous?: NormalizedReport) => {\n  if (!latest || !previous) return null;\n  const statements: string[] = [];\n\n  const gradeShift = describeShift(\"Grade\", previous.grade, latest.grade);\n  if (gradeShift) {\n    statements.push(\n      gradeShift.includes(\"newly\") || gradeShift.includes(\"no longer\")\n        ? `Differentiation profile shifted: ${gradeShift}.`\n        : `Differentiation profile shifted: ${gradeShift}.`,\n    );\n  } else {\n    statements.push(\"Differentiation remains unchanged.\");\n  }\n\n  const sizeShift = describeShift(\"Tumor size\", previous.tumorSize, latest.tumorSize);\n  if (sizeShift) {\n    const latestSize = numberFromString(latest.tumorSize);\n    const prevSize = numberFromString(previous.tumorSize);\n    const direction =\n      latestSize !== null && prevSize !== null\n        ? latestSize > prevSize\n          ? \"increased burden\"\n          : \"decreased burden\"\n        : null;\n    statements.push(`${sizeShift}${direction ? `, suggesting ${direction}` : \"\"}.`);\n  }\n\n  const marginShift = describeShift(\"Margins\", previous.margins, latest.margins);\n  if (marginShift) {\n    statements.push(`${marginShift}.`);\n  }\n\n  [\"LVI\", \"PNI\", \"nodal status\"].forEach((label) => {\n    const key =\n      label === \"nodal status\"\n        ? (\"lymphNodes\" as const)\n        : (label === \"LVI\" ? (\"lvi\" as const) : (\"pni\" as const));\n    const prev = previous[key];\n    const next = latest[key];\n    const shift = describeShift(label, prev, next);\n    if (shift) {\n      statements.push(`${shift}.`);\n    }\n  });\n\n  const ihcSummaryLatest = summarizeIhc(latest.ihcPanel);\n  if (ihcSummaryLatest) {\n    statements.push(`Current biomarker profile: ${ihcSummaryLatest}.`);\n  }\n\n  return statements.filter(Boolean).join(\" \");\n};\n\nconst coerceString = (value: unknown) => {\n  if (value === null || value === undefined) return undefined;\n  if (typeof value === \"string\") return value;\n  if (typeof value === \"number\" || typeof value === \"boolean\") return String(value);\n  return undefined;\n};\n\nconst pickValue = (bag: Record<string, unknown> | undefined, keys: string[]) => {\n  if (!bag) return undefined;\n  for (const key of keys) {\n    const candidate = coerceString(bag[key]);\n    if (candidate) return candidate;\n  }\n  return undefined;\n};\n\nconst normalizeIhcPanel = (panel?: Record<string, unknown> | null, fallback?: string) => {\n  const normalized: Record<string, string> = {};\n  if (panel) {\n    Object.entries(panel).forEach(([key, value]) => {\n      const safeValue = coerceString(value);\n      if (safeValue) {\n        normalized[key] = safeValue;\n      }\n    });\n  }\n\n  if (!Object.keys(normalized).length && fallback) {\n    fallback\n      .split(/[,;]+/)\n      .map((token) => token.trim())\n      .filter(Boolean)\n      .forEach((token) => {\n        const [marker, reading] = token.split(/[:=]/).map((segment) => segment.trim());\n        if (marker && reading) {\n          normalized[marker] = reading;\n        }\n      });\n  }\n\n  return normalized;\n};\n\nconst sortReports = (reports: NormalizedReport[]) =>\n  [...reports].sort((a, b) => {\n    const da = a.rawDate ? Date.parse(a.rawDate) : 0;\n    const db = b.rawDate ? Date.parse(b.rawDate) : 0;\n    return db - da;\n  });\n\nconst normalizeReports = (patient: Patient): NormalizedReport[] => {\n  const details = Array.isArray(patient.pathologyDetails) ? patient.pathologyDetails : [];\n  const normalized = details\n    .filter((entry): entry is PathologyDetails => !!entry && typeof entry === \"object\")\n    .map((entry, index) => {\n      const histology = (entry.histology as Record<string, unknown>) ?? {};\n      return {\n        id: `${entry.date ?? entry.procedure ?? `report-${index}`}`,\n        rawDate: entry.date,\n        dateLabel: formatDateLabel(entry.date),\n        procedure: entry.procedure,\n        site: entry.site,\n        diagnosis: entry.diagnosisText || coerceString(histology.diagnosis),\n        histotype:\n          pickValue(histology, [\"type\", \"histologic_type\", \"histotype\"]) ||\n          entry.diagnosisText ||\n          patient.histologicType,\n        grade: pickValue(histology, [\"grade\", \"tumor_grade\"]) || patient.tumorGrade || undefined,\n        tumorSize: pickValue(histology, [\"tumor_size\", \"size\", \"dimension\"]),\n        margins: pickValue(histology, [\"margins\", \"margin_status\"]) || patient.marginStatus,\n        lvi: pickValue(histology, [\"lvi\", \"lymphovascular_invasion\"]),\n        pni: pickValue(histology, [\"pni\", \"perineural_invasion\"]),\n        lymphNodes: pickValue(histology, [\"lymph_nodes\", \"nodal_status\"]),\n        ihcPanel: normalizeIhcPanel(entry.ihcPanel, patient.ihcMarkers),\n      };\n    });\n\n  if (normalized.length) {\n    return sortReports(normalized);\n  }\n\n  const fallbackDiagnosis = patient.pathologyDiagnosisText || patient.histologicType;\n  if (!fallbackDiagnosis) {\n    return [\n      {\n        id: \"no-data\",\n        dateLabel: \"Undated report\",\n        diagnosis: \"No structured pathology data available.\",\n        histotype: patient.primaryDiagnosis || \"Pathology not documented\",\n        ihcPanel: normalizeIhcPanel(undefined, patient.ihcMarkers),\n      },\n    ];\n  }\n\n  return [\n    {\n      id: \"fallback\",\n      dateLabel: \"Undated report\",\n      diagnosis: fallbackDiagnosis,\n      histotype: patient.histologicType || fallbackDiagnosis,\n      grade: patient.tumorGrade || undefined,\n      margins: patient.marginStatus || undefined,\n      ihcPanel: normalizeIhcPanel(undefined, patient.ihcMarkers),\n    },\n  ];\n};\n\nconst gradeTone = (grade?: string) => {\n  const value = grade?.toLowerCase() ?? \"\";\n  if (!value) return \"bg-slate-100 text-slate-700\";\n  if (value.includes(\"g1\") || value.includes(\"well\")) return \"bg-emerald-100 text-emerald-800\";\n  if (value.includes(\"g2\") || value.includes(\"moderate\")) return \"bg-amber-100 text-amber-900\";\n  if (value.includes(\"g3\") || value.includes(\"poor\") || value.includes(\"high\")) return \"bg-rose-100 text-rose-800\";\n  return \"bg-slate-100 text-slate-700\";\n};\n\nconst trendTone = (trend?: PathologyDelta[\"trend\"]) => {\n  switch (trend) {\n    case \"worsening\":\n      return \"text-rose-600\";\n    case \"improving\":\n      return \"text-emerald-600\";\n    case \"new\":\n      return \"text-indigo-600\";\n    default:\n      return \"text-slate-600\";\n  }\n};\n\nconst invasionTone = (value?: string) => {\n  if (!value) return \"text-slate-600\";\n  return /present|positive|involved/i.test(value) ? \"text-amber-700\" : \"text-slate-600\";\n};\n\nconst numberFromString = (value?: string) => {\n  if (!value) return null;\n  const match = value.replace(/,/g, \"\").match(/([-+]?\\d*\\.?\\d+)/);\n  if (!match) return null;\n  const parsed = Number.parseFloat(match[1]);\n  return Number.isFinite(parsed) ? parsed : null;\n};\n\nconst gradeSeverity = (grade?: string) => {\n  if (!grade) return null;\n  const match = grade.match(/g\\s*([1-4])/i);\n  if (match) return Number.parseInt(match[1], 10);\n  if (/poor|high/i.test(grade)) return 3;\n  if (/mod/i.test(grade)) return 2;\n  if (/well|low/i.test(grade)) return 1;\n  return null;\n};\n\nconst describeAggressiveness = (grade?: string) => {\n  if (!grade) return null;\n  if (/g3|poor|high/i.test(grade)) return \"high-grade biology\";\n  if (/g2|moderate/i.test(grade)) return \"intermediate-grade disease\";\n  if (/g1|well|low/i.test(grade)) return \"well-differentiated features\";\n  return `${grade} differentiation`;\n};\n\nconst describeMargins = (value?: string) => {\n  if (!value) return null;\n  if (/neg|clear|not involved/i.test(value)) {\n    return \"margins remain negative\";\n  }\n  if (/pos|involved/i.test(value)) {\n    return \"positive/close surgical margins raise recurrence risk\";\n  }\n  return `margins reported as ${value}`;\n};\n\nconst describeInvasion = (label: string, value?: string) => {\n  if (!value) return null;\n  if (/present|positive|involved/i.test(value)) {\n    return `${label} documented`;\n  }\n  if (/not|absent|negative/i.test(value)) {\n    return `${label} not identified`;\n  }\n  return `${label} noted as ${value}`;\n};\n\nconst summarizeIhc = (panel: Record<string, string>, fallback?: string) => {\n  const entries = Object.entries(panel);\n  if (entries.length === 0 && fallback) {\n    return fallback;\n  }\n  const priority = [\"ER\", \"PR\", \"HER2\", \"PD-L1\", \"Ki-67\", \"TTF-1\", \"Napsin A\", \"ALK\"];\n  const prioritized = entries\n    .sort(([a], [b]) => priority.indexOf(a) - priority.indexOf(b))\n    .slice(0, 3)\n    .map(([marker, result]) => `${marker} ${result}`);\n  if (!prioritized.length) return null;\n  return prioritized.join(\"; \");\n};\n\nconst buildSingleReportInsight = (report: NormalizedReport | undefined, patient: Patient) => {\n  if (!report) {\n    return (\n      patient.pathologyDiagnosisText ||\n      patient.histologicType ||\n      \"No structured pathology report is available yet. Upload a report to unlock richer insights.\"\n    );\n  }\n\n  const highlights = [\n    report.histotype || patient.histologicType,\n    report.grade ? `graded ${report.grade}` : null,\n    report.tumorSize ? `measuring ${report.tumorSize}` : null,\n    report.margins ? `margins ${report.margins.toLowerCase()}` : null,\n  ]\n    .filter(Boolean)\n    .join(\", \");\n\n  const invasionNotes = [report.lvi && `LVI ${report.lvi}`, report.pni && `PNI ${report.pni}`]\n    .filter(Boolean)\n    .join(\"; \");\n\n  return [\n    highlights ? `Latest pathology documents ${highlights}.` : null,\n    invasionNotes ? `Invasion status: ${invasionNotes}.` : null,\n    Object.keys(report.ihcPanel).length\n      ? `IHC profile features ${Object.entries(report.ihcPanel)\n          .slice(0, 4)\n          .map(([marker, value]) => `${marker} (${value})`)\n          .join(\", \")}.`\n      : null,\n  ]\n    .filter(Boolean)\n    .join(\" \");\n};\n\nconst buildSingleReportInterpretation = (report?: NormalizedReport, patient?: Patient) => {\n  if (!report) return null;\n  const sentences: string[] = [];\n  const aggressiveness = describeAggressiveness(report.grade);\n  const location = report.site || patient?.primaryDiagnosis;\n  const sizeDetail = report.tumorSize ? `Lesion burden is ${report.tumorSize}` : null;\n\n  sentences.push(\n    [\n      report.dateLabel !== \"Undated report\" ? `Pathology from ${report.dateLabel}` : \"Most recent pathology\",\n      report.histotype ? `confirms ${report.histotype}` : \"confirms malignant involvement\",\n      aggressiveness ? `with ${aggressiveness}` : null,\n      location ? `in the ${location}` : null,\n    ]\n      .filter(Boolean)\n      .join(\" \"),\n  );\n\n  const marginSentence = describeMargins(report.margins);\n  const invasionStatements = [\n    describeInvasion(\"LVI\", report.lvi),\n    describeInvasion(\"PNI\", report.pni),\n    describeInvasion(\"nodal involvement\", report.lymphNodes),\n  ]\n    .filter(Boolean)\n    .join(\"; \");\n\n  const ihcSummary = summarizeIhc(report.ihcPanel);\n\n  if (sizeDetail || marginSentence || invasionStatements) {\n    sentences.push(\n      [\n        sizeDetail,\n        marginSentence,\n        invasionStatements ? `${invasionStatements}; consider impact on local control.` : null,\n      ]\n        .filter(Boolean)\n        .join(\". \"),\n    );\n  }\n\n  if (ihcSummary) {\n    sentences.push(`Key immunophenotype: ${ihcSummary}.`);\n  }\n\n  return sentences.filter(Boolean).join(\" \");\n};\n\nconst describeShift = (label: string, previous?: string, latest?: string) => {\n  if (!previous && !latest) return null;\n  if (!previous && latest) return `${label} newly reported as ${latest}`;\n  if (previous && !latest) return `${label} no longer documented (was ${previous})`;\n  if (previous === latest) return null;\n  return `${label} changed from ${previous} to ${latest}`;\n};\n\nconst buildComparisonInsight = (latest?: NormalizedReport, previous?: NormalizedReport) => {\n  if (!latest || !previous) return null;\n  const updates = [\n    describeShift(\"Grade\", previous.grade, latest.grade),\n    describeShift(\"Histology\", previous.histotype, latest.histotype),\n    describeShift(\"Margins\", previous.margins, latest.margins),\n    describeShift(\"Tumor size\", previous.tumorSize, latest.tumorSize),\n    describeShift(\"LVI\", previous.lvi, latest.lvi),\n    describeShift(\"PNI\", previous.pni, latest.pni),\n  ].filter(Boolean);\n\n  const ihcChanges: string[] = [];\n  const previousIhc = previous.ihcPanel;\n  const latestIhc = latest.ihcPanel;\n  Object.keys({ ...previousIhc, ...latestIhc }).forEach((marker) => {\n    const before = previousIhc[marker];\n    const after = latestIhc[marker];\n    if (before && after && before === after) return;\n    if (!before && after) {\n      ihcChanges.push(`${marker} newly positive (${after})`);\n    } else if (before && !after) {\n      ihcChanges.push(`${marker} no longer reported (was ${before})`);\n    } else if (before && after) {\n      ihcChanges.push(`${marker} shifted from ${before} to ${after}`);\n    }\n  });\n\n  if (ihcChanges.length) {\n    updates.push(\n      `IHC panel updates: ${ihcChanges\n        .slice(0, 3)\n        .join(\"; \")}${ihcChanges.length > 3 ? \"…\" : \"\"}`,\n    );\n  }\n\n  if (!updates.length) {\n    return `No material changes detected between ${previous.dateLabel} and ${latest.dateLabel}. Continue routine surveillance unless new data emerges.`;\n  }\n\n  return `Between ${previous.dateLabel} and ${latest.dateLabel}, ${updates.join(\n    \"; \",\n  )}. These findings should be reviewed in the context of the patient's clinical trajectory.`;\n};\n\nconst generateStructuralDeltas = (\n  latest?: NormalizedReport,\n  previous?: NormalizedReport,\n): PathologyDelta[] => {\n  if (!latest || !previous) return [];\n  const deltas: PathologyDelta[] = [];\n\n  const latestGradeSeverity = gradeSeverity(latest.grade);\n  const previousGradeSeverity = gradeSeverity(previous.grade);\n  if (latest.grade || previous.grade) {\n    let trend: PathologyDelta[\"trend\"] = \"stable\";\n    if (latestGradeSeverity !== null && previousGradeSeverity !== null) {\n      if (latestGradeSeverity > previousGradeSeverity) trend = \"worsening\";\n      if (latestGradeSeverity < previousGradeSeverity) trend = \"improving\";\n    }\n    if (latest.grade !== previous.grade) {\n      deltas.push({\n        marker: \"Grade\",\n        old_value: previous.grade || \"Not graded\",\n        new_value: latest.grade || \"Not graded\",\n        trend,\n      });\n    }\n  }\n\n  const latestSize = numberFromString(latest.tumorSize);\n  const previousSize = numberFromString(previous.tumorSize);\n  if (latest.tumorSize || previous.tumorSize) {\n    let trend: PathologyDelta[\"trend\"] = \"stable\";\n    if (latestSize !== null && previousSize !== null) {\n      if (latestSize > previousSize) trend = \"worsening\";\n      if (latestSize < previousSize) trend = \"improving\";\n    }\n    if (latest.tumorSize !== previous.tumorSize) {\n      deltas.push({\n        marker: \"Tumor size\",\n        old_value: previous.tumorSize || \"Not measured\",\n        new_value: latest.tumorSize || \"Not measured\",\n        trend,\n      });\n    }\n  }\n\n  if (latest.margins || previous.margins) {\n    let trend: PathologyDelta[\"trend\"] = \"stable\";\n    const positive = (value?: string) => !!value && /pos|involved|positive/i.test(value);\n    const wasPositive = positive(previous.margins);\n    const isPositive = positive(latest.margins);\n    if (isPositive && !wasPositive) trend = \"worsening\";\n    if (!isPositive && wasPositive) trend = \"improving\";\n    if (latest.margins !== previous.margins) {\n      deltas.push({\n        marker: \"Margins\",\n        old_value: previous.margins || \"Not assessed\",\n        new_value: latest.margins || \"Not assessed\",\n        trend,\n      });\n    }\n  }\n\n  ([\n    { label: \"Lymphovascular invasion\", latest: latest.lvi, previous: previous.lvi },\n    { label: \"Perineural invasion\", latest: latest.pni, previous: previous.pni },\n    { label: \"Nodal status\", latest: latest.lymphNodes, previous: previous.lymphNodes },\n  ] as const).forEach((field) => {\n    if (field.latest === field.previous) return;\n    if (!field.latest && !field.previous) return;\n    deltas.push({\n      marker: field.label,\n      old_value: field.previous || \"Not documented\",\n      new_value: field.latest || \"Not documented\",\n      trend:\n        field.latest && /present|positive|involved/i.test(field.latest)\n          ? \"worsening\"\n          : field.previous && /present|positive|involved/i.test(field.previous)\n            ? \"improving\"\n            : \"stable\",\n    });\n  });\n\n  Object.keys({ ...previous.ihcPanel, ...latest.ihcPanel })\n    .slice(0, 6)\n    .forEach((marker) => {\n      const oldValue = previous.ihcPanel[marker];\n      const newValue = latest.ihcPanel[marker];\n      if (oldValue === newValue) return;\n      if (!oldValue && !newValue) return;\n      deltas.push({\n        marker: `IHC · ${marker}`,\n        old_value: oldValue || \"Not reported\",\n        new_value: newValue || \"Not reported\",\n        trend: !oldValue ? \"new\" : !newValue ? \"improving\" : \"stable\",\n      });\n    });\n\n  return deltas;\n};\n\nexport function PathologyView({ patient, aiInsights }: PathologyViewProps) {\n  const reports = useMemo(() => normalizeReports(patient), [patient]);\n  const [selectedReportIndex, setSelectedReportIndex] = useState(0);\n\n  useEffect(() => {\n    setSelectedReportIndex(0);\n  }, [reports.length]);\n\n  const selectedReport = reports[selectedReportIndex] ?? reports[0];\n  const hasMultipleReports = reports.length > 1;\n  const aiInvestigation = aiInsights?.investigations;\n  const latestReport = reports[0];\n  const previousReport = hasMultipleReports ? reports[1] : undefined;\n  const fallbackSingleInsight = useMemo(\n    () => buildSingleReportInsight(latestReport ?? selectedReport, patient),\n    [latestReport, selectedReport, patient],\n  );\n  const fallbackComparisonInsight = useMemo(\n    () => buildComparisonInsight(latestReport, previousReport),\n    [latestReport, previousReport],\n  );\n  const clinicalInterpretation = hasMultipleReports\n    ? buildComparisonInterpretation(latestReport, previousReport)\n    : buildSingleReportInterpretation(latestReport ?? selectedReport, patient);\n\n  const aiNarrative = hasMultipleReports\n    ? aiInvestigation?.pathology_comparison_text?.trim() ||\n      fallbackComparisonInsight ||\n      \"Comparison insight unavailable. Review manual synopsis below.\"\n    : aiInvestigation?.pathology_summary?.trim() ||\n      aiInvestigation?.pathology_comparison_text?.trim() ||\n      fallbackSingleInsight;\n  const aiDeltas = hasMultipleReports ? aiInvestigation?.pathology_deltas ?? [] : [];\n  const structuralDeltas = useMemo(() => {\n    if (!hasMultipleReports) return [];\n    if (aiDeltas.length) return aiDeltas;\n    return generateStructuralDeltas(latestReport, previousReport);\n  }, [aiDeltas, hasMultipleReports, latestReport, previousReport]);\n  const invasionFields = [\n    { label: \"Lymphovascular Invasion\", value: selectedReport?.lvi },\n    { label: \"Perineural Invasion\", value: selectedReport?.pni },\n    { label: \"Lymph Nodes\", value: selectedReport?.lymphNodes },\n  ];\n\n  const ihcEntries = Object.entries(selectedReport?.ihcPanel ?? {});\n\n  return (\n    <div className=\"flex h-full gap-6\">\n      <div className=\"flex-1 space-y-6\">\n        <section className={CARD}>\n          <div className=\"flex items-start justify-between gap-4\">\n            <div>\n              <p className={SECTION_HEADER}>Insight</p>\n              <p className={CARD_TITLE}>\n                {hasMultipleReports\n                  ? `Comparison · ${previousReport?.dateLabel ?? \"Prior\"} → ${latestReport?.dateLabel ?? \"Latest\"}`\n                  : `Single report · ${latestReport?.dateLabel ?? \"Undated\"}`}\n              </p>\n              {clinicalInterpretation && (\n                <p className={`${BODY_TEXT} mt-2`}>\n                  <span className=\"font-semibold text-slate-900\">Clinical interpretation:</span> {clinicalInterpretation}\n                </p>\n              )}\n            </div>\n            <div className={`${BADGE} bg-indigo-50 text-indigo-700`}>\n              <GitCompare className=\"mr-2 h-4 w-4\" />\n              {hasMultipleReports ? \"Comparison\" : \"Single report\"}\n            </div>\n          </div>\n\n          {hasMultipleReports && (\n            <div className=\"mt-4 overflow-hidden rounded-xl border border-slate-200\">\n              <div className=\"grid grid-cols-[2fr_3fr_1fr] bg-slate-50 px-4 py-2 text-xs font-medium uppercase tracking-wide text-slate-500\">\n                <span>Marker</span>\n                <span>Previous → Current</span>\n                <span className=\"text-right\">Trend</span>\n              </div>\n              {structuralDeltas.length ? (\n                structuralDeltas.slice(0, 5).map((delta) => (\n                  <div\n                    key={`${delta.marker}-${delta.trend}-${delta.new_value}-${delta.old_value}`}\n                    className=\"grid grid-cols-[2fr_3fr_1fr] border-t border-slate-100 px-4 py-3 text-sm\"\n                  >\n                    <span className=\"font-semibold text-slate-900\">{delta.marker}</span>\n                    <span className={BODY_TEXT}>\n                      {delta.old_value ?? \"—\"} <span className=\"text-slate-400\">→</span> {delta.new_value ?? \"—\"}\n                    </span>\n                    <span className={`flex items-center justify-end gap-1 text-xs font-semibold ${trendTone(delta.trend)}`}>\n                      <AlertCircle className=\"h-3.5 w-3.5\" />\n                      {delta.trend ?? \"stable\"}\n                    </span>\n                  </div>\n                ))\n              ) : (\n                <p className=\"px-4 py-3 text-sm text-slate-500\">\n                  Structured deltas could not be derived between these reports. Review the synopsis above for qualitative\n                  context.\n                </p>\n              )}\n            </div>\n          )}\n        </section>\n\n        <section className={CARD}>\n          <div className=\"flex items-start justify-between border-b border-slate-100 pb-5\">\n            <div>\n              <p className={SECTION_HEADER}>Synoptic Report Detail</p>\n              <h2 className=\"text-lg font-semibold text-slate-900\">\n                {selectedReport?.diagnosis || selectedReport?.histotype || \"Pathology diagnosis not provided\"}\n              </h2>\n              <p className={`${LABEL_TEXT} mt-1`}>\n                {[selectedReport?.procedure, selectedReport?.dateLabel, selectedReport?.site].filter(Boolean).join(\" • \") ||\n                  \"Procedure metadata not documented\"}\n              </p>\n            </div>\n            <div className={`${BADGE} border border-slate-200 text-slate-700`}>\n              <FileText className=\"mr-2 h-4 w-4\" />\n              Report {selectedReportIndex + 1} of {reports.length}\n            </div>\n          </div>\n\n          <div className=\"space-y-6 pt-6\">\n            <div className={`grid ${GRID_GAP} md:grid-cols-2 xl:grid-cols-4`}>\n              <div className={SOFT_CARD}>\n                <p className={LABEL_TEXT}>Histotype</p>\n                <p className=\"mt-2 text-base font-semibold text-slate-900\">\n                  {selectedReport?.histotype || \"Not documented\"}\n                </p>\n              </div>\n              <div className={SOFT_CARD}>\n                <p className={LABEL_TEXT}>Grade</p>\n                <span className={`${BADGE} mt-2 ${gradeTone(selectedReport?.grade)}`}>\n                  {selectedReport?.grade || \"Not graded\"}\n                </span>\n              </div>\n              <div className={SOFT_CARD}>\n                <p className={LABEL_TEXT}>Tumor Size</p>\n                <p className=\"mt-2 text-base font-semibold text-slate-900\">\n                  {selectedReport?.tumorSize || \"Not measured\"}\n                </p>\n              </div>\n              <div className={SOFT_CARD}>\n                <p className={LABEL_TEXT}>Margins</p>\n                <div className=\"mt-2 inline-flex items-center gap-2\">\n                  <span\n                    className={`h-2.5 w-2.5 rounded-full ${\n                      /negative|clear|not involved/i.test(selectedReport?.margins ?? \"\")\n                        ? \"bg-emerald-500\"\n                        : \"bg-rose-500\"\n                    }`}\n                  />\n                  <p className=\"text-base font-semibold text-slate-900\">\n                    {selectedReport?.margins || \"Not assessed\"}\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            <div>\n              <p className={SECTION_HEADER}>Invasion & Risk Flags</p>\n              <div className=\"mt-3 grid gap-3 md:grid-cols-3\">\n                {invasionFields.map((field) => (\n                  <div key={field.label} className=\"rounded-xl border border-slate-100 bg-white px-4 py-3\">\n                    <p className={LABEL_TEXT}>{field.label}</p>\n                    <p className={`mt-2 text-base font-semibold ${invasionTone(field.value)}`}>\n                      {field.value || \"Not assessed\"}\n                    </p>\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            <div>\n              <p className={SECTION_HEADER}>IHC Profile</p>\n              {ihcEntries.length ? (\n                <div className=\"mt-3 flex flex-wrap gap-2\">\n                  {ihcEntries.map(([marker, result]) => {\n                    const positive = /pos|positive|\\+/i.test(result);\n                    return (\n                      <span\n                        key={marker}\n                        className={`${BADGE} ${positive ? \"bg-emerald-50 text-emerald-700\" : \"bg-slate-100 text-slate-700\"}`}\n                      >\n                        {marker}: {result}\n                      </span>\n                    );\n                  })}\n                </div>\n              ) : (\n                <p className={BODY_TEXT}>IHC panel not provided.</p>\n              )}\n            </div>\n          </div>\n        </section>\n      </div>\n\n      <aside className={`${SIDEBAR_WIDTH} shrink-0 overflow-y-auto rounded-xl border border-slate-200 bg-white p-4`}>\n        <p className={SECTION_HEADER}>Timeline</p>\n        <ul className=\"space-y-2\">\n          {reports.map((report, index) => {\n            const isActive = index === selectedReportIndex;\n            return (\n              <li key={report.id}>\n                <button\n                  type=\"button\"\n                  onClick={() => setSelectedReportIndex(index)}\n                  disabled={!hasMultipleReports}\n                  className={`w-full rounded-lg border px-4 py-3 text-left transition ${\n                    isActive\n                      ? \"border-slate-900 bg-slate-100 text-slate-900\"\n                      : \"border-slate-200 bg-white text-slate-600 hover:border-slate-300\"\n                  } ${hasMultipleReports ? \"cursor-pointer\" : \"cursor-default\"}`}\n                >\n                  <p className=\"text-sm font-semibold text-slate-900\">{report.dateLabel}</p>\n                  {report.procedure ? (\n                    <p className={LABEL_TEXT}>{report.procedure}</p>\n                  ) : (\n                    <p className=\"text-xs text-slate-400\">Procedure not documented</p>\n                  )}\n                </button>\n              </li>\n            );\n          })}\n        </ul>\n      </aside>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/investigations/radiology-view.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/patient-tab.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/tabs/references-tab.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CARD_TITLE' is defined but never used.","line":6,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { Dna, FileImage, FileText, Microscope } from \"lucide-react\";\n\nimport type { Patient } from \"@/types/patient\";\nimport { BADGE, BODY_TEXT, CARD, CARD_TITLE, LABEL_TEXT, SECTION_HEADER } from \"./design-system\";\n\ntype DocumentEntry = {\n  date?: string;\n  title: string;\n  type: \"radiology\" | \"pathology\" | \"genomics\" | \"notes\";\n  url?: string | null;\n};\n\nconst formatDate = (value?: string) => {\n  if (!value) return \"\";\n  const timestamp = Date.parse(value);\n  if (Number.isNaN(timestamp)) return value;\n  return new Intl.DateTimeFormat(\"en\", { month: \"short\", day: \"numeric\", year: \"numeric\" }).format(new Date(timestamp));\n};\n\nconst normalizePathologyLinks = (raw?: string | null): DocumentEntry[] => {\n  if (!raw) return [];\n  return raw\n    .split(/[,;\\n]+/)\n    .map((entry) => entry.trim())\n    .filter(Boolean)\n    .map((link, index) => ({\n      date: undefined,\n      title: `Pathology Report ${index + 1}`,\n      type: \"pathology\",\n      url: link,\n    }));\n};\n\ninterface DocumentLibrary {\n  radiology: DocumentEntry[];\n  pathology: DocumentEntry[];\n  genomics: DocumentEntry[];\n  notes: DocumentEntry[];\n}\n\nconst buildDocumentLibrary = (patient: Patient): DocumentLibrary => {\n  const radiology: DocumentEntry[] = (patient.radiologyReports ?? []).map((report) => ({\n    date: report.date,\n    title: report.modality || report.summary || \"Radiology Report\",\n    type: \"radiology\",\n    url: report.link,\n  }));\n\n  const genomics: DocumentEntry[] = (patient.genomicReports ?? []).map((report) => ({\n    date: report.date,\n    title: report.summary ? `${report.summary.slice(0, 70)}${report.summary.length > 70 ? \"…\" : \"\"}` : \"Genomic Panel\",\n    type: \"genomics\",\n    url: report.link,\n  }));\n\n  const providerNotes: DocumentEntry[] = (patient.providerNotes ?? []).map((note) => ({\n    date: note.date,\n    title: note.summary || \"Clinical Encounter\",\n    type: \"notes\",\n    url: note.link,\n  }));\n\n  const noteEntriesFromJson: DocumentEntry[] = (() => {\n    if (!patient.providerNoteLinks) return [];\n    try {\n      const parsed = JSON.parse(patient.providerNoteLinks) as unknown;\n      if (!Array.isArray(parsed)) return [];\n      return (parsed as unknown[]).reduce<DocumentEntry[]>((acc, entry) => {\n        if (!entry || typeof entry !== \"object\") {\n          return acc;\n        }\n        const record = entry as Record<string, unknown>;\n        acc.push({\n          date: typeof record.date === \"string\" ? record.date : undefined,\n          title:\n            (typeof record.note_type === \"string\" && record.note_type) ||\n            (typeof record.summary === \"string\" && record.summary) ||\n            \"Clinical Encounter\",\n          type: \"notes\",\n          url: typeof record.link === \"string\" ? record.link : undefined,\n        });\n        return acc;\n      }, []);\n    } catch {\n      return [];\n    }\n  })();\n\n  const notes = [...noteEntriesFromJson, ...providerNotes];\n\n  const pathologyFromDetails = (patient.pathologyDetails ?? []).reduce<DocumentEntry[]>((acc, detail) => {\n    const raw = detail.raw as Record<string, unknown> | undefined;\n    const link = typeof raw?.link === \"string\" ? raw?.link : undefined;\n    if (link) {\n      acc.push({\n        date: detail.date,\n        title: detail.procedure || detail.site || \"Pathology Report\",\n        type: \"pathology\",\n        url: link,\n      });\n    }\n    return acc;\n  }, []);\n\n  const pathologyLinks = normalizePathologyLinks(patient.pathologyReportLinks);\n  const pathology = [...pathologyFromDetails, ...pathologyLinks];\n\n  return {\n    radiology,\n    pathology,\n    genomics,\n    notes,\n  };\n};\n\nconst SectionIcon = {\n  radiology: FileImage,\n  pathology: Microscope,\n  genomics: Dna,\n  notes: FileText,\n};\n\ninterface ReferencesTabProps {\n  patient: Patient;\n}\n\nexport function ReferencesTab({ patient }: ReferencesTabProps) {\n  const library = buildDocumentLibrary(patient);\n\n  const sections: {\n    key: keyof DocumentLibrary;\n    title: string;\n    description: string;\n  }[] = [\n    { key: \"radiology\", title: \"Radiology Images & Reports\", description: \"CT, MRI, X-ray, and other imaging studies.\" },\n    { key: \"pathology\", title: \"Pathology & Lab Reports\", description: \"Histology, surgical pathology, and lab reports.\" },\n    { key: \"genomics\", title: \"Genomic Profiles\", description: \"Molecular testing, NGS panels, and targeted sequencing.\" },\n    { key: \"notes\", title: \"Clinical Notes & Summaries\", description: \"Consult notes, encounter summaries, and discharge reports.\" },\n  ];\n\n  return (\n    <div className=\"space-y-6\">\n      <header className=\"space-y-2\">\n        <p className={SECTION_HEADER}>References</p>\n        <h2 className=\"text-lg font-semibold text-slate-900\">Clinical Documents & References</h2>\n        <p className={BODY_TEXT}>Centralized access to imaging, pathology, genomic, and clinical documents.</p>\n      </header>\n\n      <div className=\"space-y-6\">\n        {sections.map((section) => {\n          const items = library[section.key];\n          const Icon = SectionIcon[section.key];\n          return (\n            <section key={section.key} className={CARD}>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className={SECTION_HEADER}>{section.title}</p>\n                  <p className={LABEL_TEXT}>{section.description}</p>\n                </div>\n              </div>\n\n              {items.length ? (\n                <ul className=\"mt-4 space-y-3\">\n                  {items.map((doc, index) => (\n                    <li\n                      key={`${section.key}-${index}-${doc.title}`}\n                      className=\"flex items-center justify-between rounded-xl border border-slate-100 bg-slate-50 px-4 py-3\"\n                    >\n                      <div className=\"flex flex-1 items-center gap-3\">\n                        <div className=\"flex h-10 w-10 items-center justify-center rounded-2xl bg-white text-slate-600 shadow\">\n                          <Icon className=\"h-4 w-4\" />\n                        </div>\n                        <div>\n                          <p className=\"text-sm font-semibold text-slate-900\">{doc.title}</p>\n                          <p className={LABEL_TEXT}>{formatDate(doc.date)}</p>\n                        </div>\n                      </div>\n                      {doc.url ? (\n                        <a\n                          href={doc.url}\n                          target=\"_blank\"\n                          rel=\"noreferrer\"\n                          className={`${BADGE} border border-slate-200 text-slate-600 hover:border-slate-900 hover:text-slate-900`}\n                        >\n                          View\n                        </a>\n                      ) : (\n                        <span className={LABEL_TEXT}>No link</span>\n                      )}\n                    </li>\n                  ))}\n                </ul>\n              ) : (\n                <div className=\"mt-4 rounded-xl border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500\">\n                  No documents available.\n                </div>\n              )}\n            </section>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/components/ui/ai-loader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/hooks/use-pdf-generator.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5088,5091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5088,5091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5697,5700],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5697,5700],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useCallback, useState } from \"react\";\nimport jsPDF from \"jspdf\";\nimport autoTable from \"jspdf-autotable\";\n\nimport type { Patient, TimelineEvent } from \"@/types/patient\";\n\ninterface ClinicalSummaryResponse {\n  clinical_narrative: string;\n  status_one_liner?: string;\n  key_risks: string[];\n  recommendations: string[];\n}\n\nconst formatDate = (value?: string | null) => {\n  if (!value) return \"—\";\n  const timestamp = Date.parse(value);\n  if (Number.isNaN(timestamp)) return value;\n  return new Intl.DateTimeFormat(\"en-US\", { year: \"numeric\", month: \"short\", day: \"numeric\" }).format(\n    new Date(timestamp),\n  );\n};\n\nconst latestValue = (source?: string | null, key?: string) => {\n  if (!source) return \"—\";\n  const match = source.match(new RegExp(`${key ?? \"\"}[:=]?\\\\s*([\\\\d.]+)`, \"i\"));\n  if (match) return match[1];\n  return source.split(/[,;]+/)[0]?.trim() || \"—\";\n};\n\nconst pickTreatment = (timeline?: TimelineEvent[]) => {\n  if (!timeline?.length) return null;\n  return timeline.find((event) => !event.endDate) ?? timeline[0];\n};\n\nexport const usePDFGenerator = (patient: Patient) => {\n  const [isGenerating, setIsGenerating] = useState(false);\n\n  const generatePDF = useCallback(async () => {\n    if (isGenerating) return;\n    setIsGenerating(true);\n\n    let summary: ClinicalSummaryResponse = {\n      clinical_narrative: \"Summary unavailable.\",\n      status_one_liner: \"Disease status not documented.\",\n      key_risks: [],\n      recommendations: [],\n    };\n\n    try {\n      const response = await fetch(\"/api/clinical-summary\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ patient }),\n      });\n      if (response.ok) {\n        summary = (await response.json()) as ClinicalSummaryResponse;\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch clinical summary\", error);\n    }\n\n    const doc = new jsPDF({ unit: \"pt\" });\n    const marginX = 48;\n    let cursorY = 60;\n\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setFontSize(18);\n    doc.text(\"Oncology Clinical Dashboard\", marginX, cursorY);\n\n    cursorY += 30;\n    doc.setFontSize(12);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.text(`Name: ${patient.name || \"—\"}`, marginX, cursorY);\n    doc.text(`Patient ID: ${patient.patientId}`, marginX + 240, cursorY);\n    cursorY += 18;\n    const dateOfBirth = patient.dateOfBirth ?? patient.birthDate ?? \"—\";\n    doc.text(`Age: ${patient.age ?? \"—\"}`, marginX, cursorY);\n    doc.text(`Sex: ${patient.sex || \"—\"}`, marginX + 120, cursorY);\n    doc.text(`DOB: ${dateOfBirth}`, marginX + 240, cursorY);\n    cursorY += 18;\n    doc.text(\n      `Diagnosis: ${patient.primaryDiagnosis || patient.histologicType || \"—\"} | ${\n        patient.currentTnmStage || patient.initialTnmStage || \"Stage N/A\"\n      } | ${patient.actionableMutationSummary || \"Driver not reported\"}`,\n      marginX,\n      cursorY,\n    );\n\n    cursorY += 32;\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setFontSize(12);\n    doc.text(\"Current Status\", marginX, cursorY);\n    cursorY += 16;\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setFontSize(11);\n    doc.text(summary.status_one_liner || patient.overallDiseaseCourseSummary || \"Status not documented.\", marginX, cursorY);\n    cursorY += 18;\n    doc.setFont(\"helvetica\", \"bolditalic\");\n    doc.setFontSize(14);\n    doc.text(\"Clinical Assessment\", marginX, cursorY);\n    cursorY += 18;\n    doc.setFont(\"times\", \"italic\");\n    doc.setFontSize(11);\n    const narrativeLines = doc.splitTextToSize(summary.clinical_narrative || \"Summary unavailable.\", 520);\n    doc.text(narrativeLines, marginX, cursorY);\n    cursorY += narrativeLines.length * 14 + 10;\n\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setFontSize(12);\n    doc.text(\"Key Risks\", marginX, cursorY);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setFontSize(11);\n    const risks = summary.key_risks?.length ? summary.key_risks : [\"Not documented\"];\n    risks.forEach((risk, index) => {\n      doc.text(`• ${risk}`, marginX, cursorY + 16 + index * 14);\n    });\n    cursorY += 16 + risks.length * 14;\n\n    doc.setFont(\"helvetica\", \"bold\");\n    doc.setFontSize(12);\n    doc.text(\"Recommendations\", marginX, cursorY);\n    doc.setFont(\"helvetica\", \"normal\");\n    doc.setFontSize(11);\n    const recs = summary.recommendations?.length ? summary.recommendations : [\"Continue surveillance.\"];\n    recs.forEach((rec, index) => {\n      doc.text(`• ${rec}`, marginX, cursorY + 16 + index * 14);\n    });\n    cursorY += 24 + recs.length * 14;\n\n    const currentTreatment = pickTreatment(patient.treatmentTimeline);\n    const treatmentRows = [\n      [\n        currentTreatment?.regimen || patient.currentLineOfTherapy || \"Not documented\",\n        formatDate(currentTreatment?.startDate),\n        patient.responsePerLine || \"Not recorded\",\n      ],\n    ];\n\n    autoTable(doc, {\n      startY: cursorY,\n      head: [[\"Current Drug\", \"Start Date\", \"Last Response\"]],\n      body: treatmentRows,\n      margin: { left: marginX, right: marginX },\n      styles: { fontSize: 10 },\n    });\n\n    const labsStartY = (doc as any).lastAutoTable.finalY + 24;\n    const labRows = [\n      [\"WBC\", latestValue(patient.cbcValues, \"WBC\")],\n      [\"Hb\", latestValue(patient.cbcValues, \"Hb\")],\n      [\"Plt\", latestValue(patient.cbcValues, \"Plt\")],\n      [\"Cr\", latestValue(patient.cmpValues, \"Cr\")],\n      [\"AST\", latestValue(patient.cmpValues, \"AST\")],\n    ];\n\n    autoTable(doc, {\n      startY: labsStartY,\n      head: [[\"Latest Labs\", \"Value\"]],\n      body: labRows,\n      margin: { left: marginX, right: marginX },\n      styles: { fontSize: 10 },\n      columnStyles: { 0: { fontStyle: \"bold\" } },\n    });\n\n    const alertsStartY = (doc as any).lastAutoTable.finalY + 24;\n    const alertRows = [\n      [\"Abnormal lab flags\", patient.abnormalLabFlags || \"None documented\"],\n      [\"Renal Dysfunction\", patient.renalDysfunctionFlag ? \"Active\" : \"None\"],\n      [\"Liver Dysfunction\", patient.liverDysfunctionFlag ? \"Active\" : \"None\"],\n    ];\n\n    autoTable(doc, {\n      startY: alertsStartY,\n      head: [[\"Key Alerts\", \"Status\"]],\n      body: alertRows,\n      margin: { left: marginX, right: marginX },\n      styles: { fontSize: 10 },\n    });\n\n    const fileName = `${patient.patientId}_Summary_${new Date().toISOString().slice(0, 10)}.pdf`;\n    doc.save(fileName);\n    setIsGenerating(false);\n  }, [isGenerating, patient]);\n\n  return { isGenerating, generatePDF };\n};\n","usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/lib/clinical-summary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/lib/data-service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/lib/gemini.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/lib/patient-insights.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/lib/performance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/types/dashboard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/types/patient-insights.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/Users/a38371/Desktop/onco/src/types/patient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
